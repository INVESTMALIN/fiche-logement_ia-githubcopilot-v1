# üì∏ PLAN UPLOAD PHOTOS - Architecture Compl√®te OP√âRATIONNELLE
*Mise √† jour : 18 juillet 2025üéØ*

---

## üèÜ **STATUT ACTUEL - SUCC√àS COMPLET ‚úÖ**

### ‚úÖ **Phase 1 : Upload Photos**
- **‚úÖ Composant PhotoUpload** int√©gr√© dans toutes les sections
- **‚úÖ Upload Supabase Storage** fonctionnel avec structure organis√©e
- **‚úÖ Sauvegarde FormContext** automatique des URLs
- **‚úÖ Interface utilisateur** intuitive (drag & drop + bouton)
- **‚úÖ Gestion erreurs** robuste avec messages utilisateur

### ‚úÖ **Phase 2 : Webhook Conditionnel**
- **‚úÖ Trigger SQL** se d√©clenche on UPADTE
- **‚úÖ Payload COMPLET** optimis√© avce les champs n√©cessaires (39 champs fichiers m√©dias)
- **‚úÖ Make.com** re√ßoit donn√©es structur√©es
- **‚úÖ Tests end-to-end** valid√©s avec fiches r√©elles


---

## üéØ **ARCHITECTURE FINALE VALID√âE**

### **Workflow Complet : Frontend ‚Üí Supabase ‚Üí Make ‚Üí Drive**

```
    A[Utilisateur finalise fiche] --> B[G√©n√©ration 2 PDF automatique]
    B --> C[Upload PDF vers Storage]
    C --> D[UPDATE statut fiche = 'Compl√©t√©']
    D --> E[Trigger filtre statut = 'Compl√©t√©' dans Make]
    E --> F[Webhook Make avec payload optimis√©]
    F --> G[Make t√©l√©charge + organise photos]
    G --> H[Cr√©ation arborescence Google Drive]
    H --> I[Upload final organis√© par sections]
```

---

## üìä **STRUCTURE DONN√âES FINALIS√âE**

### **Supabase Storage**
```
üìÅ Bucket "fiche-photos" (PUBLIC)
‚îú‚îÄ‚îÄ user-fb6faa31-a18a-46bf-aec8-46e3bfc7ff17/
‚îÇ   ‚îú‚îÄ‚îÄ fiche-1137/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ section_clefs/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ clefs/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ 1752111595319_qn38vf_screenshot.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ section_equipements/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ poubelle_photos/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ disjoncteur_photos/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ section_gestion_linge/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ photos_linge/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ emplacement_photos/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ section_securite/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ photos_equipements_securite/
‚îÇ   ‚îî‚îÄ‚îÄ fiche-{autre}/
‚îî‚îÄ‚îÄ user-{autre}/

üìÅ Bucket "fiche-pdfs" (PUBLIC)
‚îú‚îÄ‚îÄ fiche-logement-1137.pdf
‚îú‚îÄ‚îÄ fiche-menage-1137.pdf
‚îî‚îÄ‚îÄ ...
```

### **Base de Donn√©es - Colonnes Photos**
```sql
-- Exemples de colonnes photos fonctionnelles
equipements_poubelle_photos TEXT[]
equipements_disjoncteur_photos TEXT[]
linge_photos_linge TEXT[]
linge_emplacement_photos TEXT[]
clefs_photos TEXT[]
securite_photos_equipements_securite TEXT[]
pdf_logement_url TEXT
pdf_menage_url TEXT
```

---

## üîß **WEBHOOK SUPABASE - TRIGGER OP√âRATIONNEL**

## üîó **Automatisation Make.com**

### **Webhook Optimis√© (BUG #004 r√©solu)**

**Probl√®me initial :** Payload 750+ colonnes ing√©rable dans Make

**Solution :** Trigger SQL avec payload structur√© optimis√©

```sql
-- Trigger actuel en production : fiche_any_update_webhook
-- Fonction actuelle : notify_fiche_completed()

CREATE OR REPLACE FUNCTION public.notify_fiche_completed()
RETURNS trigger
LANGUAGE plpgsql
AS $function$
BEGIN
  -- ‚ö†Ô∏è AM√âLIORATION RECOMMAND√âE : Ajouter protection doublons
  -- IF NEW.statut = 'Compl√©t√©' AND (OLD.statut IS NULL OR OLD.statut != 'Compl√©t√©') THEN
  
  -- Version actuelle : d√©clench√© √† chaque fois que statut = "Compl√©t√©"
  IF NEW.statut = 'Compl√©t√©' THEN
    PERFORM net.http_post(
      url := 'https://hook.eu2.make.com/ydjwftmd7czs4rygv1rjhi6u4pvb4gdj',
      body := jsonb_build_object(
        -- üìã M√âTADONN√âES (5 champs)
        'id', NEW.id,
        'nom', NEW.nom,
        'statut', NEW.statut,
        'created_at', NEW.created_at,
        'updated_at', NEW.updated_at,
        
        -- üë§ PROPRI√âTAIRE (7 champs structur√©s)
        'proprietaire', jsonb_build_object(
          'prenom', NEW.proprietaire_prenom,
          'nom', NEW.proprietaire_nom,
          'email', NEW.proprietaire_email,
          'adresse_rue', NEW.proprietaire_adresse_rue,
          'adresse_complement', NEW.proprietaire_adresse_complement,
          'adresse_ville', NEW.proprietaire_adresse_ville,
          'adresse_code_postal', NEW.proprietaire_adresse_code_postal
        ),
        
        -- üè† LOGEMENT (6 champs Monday)
        'logement', jsonb_build_object(
          'numero_bien', NEW.logement_numero_bien,
          'type_propriete', NEW.logement_type_propriete,
          'typologie', NEW.logement_typologie,
          'surface', NEW.logement_surface,
          'nombre_personnes_max', NEW.logement_nombre_personnes_max,
          'nombre_lits', NEW.logement_nombre_lits
        ),
        
        -- üìÑ PDFS (2 URLs)
        'pdfs', jsonb_build_object(
          'logement_url', NEW.pdf_logement_url,
          'menage_url', NEW.pdf_menage_url
        ),
        
        -- üì∏ M√âDIAS (39 champs organis√©s par section) - NOMS R√âELS SUPABASE
        'media', jsonb_build_object(
          -- Section Clefs (5 champs)
          'clefs_emplacement_photo', NEW.clefs_emplacement_photo,
          'clefs_interphone_photo', NEW.clefs_interphone_photo,
          'clefs_tempo_gache_photo', NEW.clefs_tempo_gache_photo,
          'clefs_digicode_photo', NEW.clefs_digicode_photo,
          'clefs_photos', NEW.clefs_photos,
          
          -- Section √âquipements (4 champs)
          'equipements_poubelle_photos', NEW.equipements_poubelle_photos,
          'equipements_disjoncteur_photos', NEW.equipements_disjoncteur_photos,
          'equipements_vanne_eau_photos', NEW.equipements_vanne_eau_photos,
          'equipements_chauffage_eau_photos', NEW.equipements_chauffage_eau_photos,
          
          -- Section Gestion Linge (2 champs)
          'linge_photos_linge', NEW.linge_photos_linge,
          'linge_emplacement_photos', NEW.linge_emplacement_photos,
          
          -- Section Chambres (6 champs)
          'chambres_chambre_1_photos', NEW.chambres_chambre_1_photos_chambre,
          'chambres_chambre_2_photos', NEW.chambres_chambre_2_photos_chambre,
          'chambres_chambre_3_photos', NEW.chambres_chambre_3_photos_chambre,
          'chambres_chambre_4_photos', NEW.chambres_chambre_4_photos_chambre,
          'chambres_chambre_5_photos', NEW.chambres_chambre_5_photos_chambre,
          'chambres_chambre_6_photos', NEW.chambres_chambre_6_photos_chambre,
          
          -- Section Salles de Bains (6 champs)
          'salle_de_bain_1_photos', NEW.salle_de_bains_salle_de_bain_1_photos_salle_de_bain,
          'salle_de_bain_2_photos', NEW.salle_de_bains_salle_de_bain_2_photos_salle_de_bain,
          'salle_de_bain_3_photos', NEW.salle_de_bains_salle_de_bain_3_photos_salle_de_bain,
          'salle_de_bain_4_photos', NEW.salle_de_bains_salle_de_bain_4_photos_salle_de_bain,
          'salle_de_bain_5_photos', NEW.salle_de_bains_salle_de_bain_5_photos_salle_de_bain,
          'salle_de_bain_6_photos', NEW.salle_de_bains_salle_de_bain_6_photos_salle_de_bain,
          
          -- Section Cuisines (7 champs)
          'cuisine1_cuisiniere_photo', NEW.cuisine_1_cuisiniere_photo,
          'cuisine1_plaque_cuisson_photo', NEW.cuisine_1_plaque_cuisson_photo,
          'cuisine1_four_photo', NEW.cuisine_1_four_photo,
          'cuisine1_micro_ondes_photo', NEW.cuisine_1_micro_ondes_photo,
          'cuisine1_lave_vaisselle_photo', NEW.cuisine_1_lave_vaisselle_photo,
          'cuisine1_cafetiere_photo', NEW.cuisine_1_cafetiere_photo,
          'cuisine2_photos_tiroirs_placards', NEW.cuisine_2_photos_tiroirs_placards,
          
          -- Section Salon/SAM (1 champ)
          'salon_sam_photos', NEW.salon_sam_photos_salon_sam,
          
          -- Section √âquipements Sp√©ciaux/Ext√©rieur (3 champs)
          'exterieur_photos_espaces', NEW.equip_spe_ext_exterieur_photos,
          'jacuzzi_photos_jacuzzi', NEW.equip_spe_ext_jacuzzi_photos,
          'barbecue_photos', NEW.equip_spe_ext_barbecue_photos,
          
          -- Section Communs (1 champ)
          'communs_photos_espaces', NEW.communs_photos_espaces_communs,
          
          -- Section B√©b√© (1 champ)
          'bebe_photos_equipements', NEW.bebe_photos_equipements_bebe,
          
          -- Section Guide d'acc√®s (2 champs)
          'guide_acces_photos_etapes', NEW.guide_acces_photos_etapes,
          'guide_acces_video_acces', NEW.guide_acces_video_acces,
          
          -- Section S√©curit√© (1 champ)
          'securite_photos_equipements', NEW.securite_photos_equipements_securite
        )
      ),
      headers := '{"Content-Type": "application/json"}'::jsonb
    );
  END IF;
  RETURN NEW;
END;
$function$;

-- Trigger associ√©
CREATE TRIGGER fiche_any_update_webhook
  AFTER UPDATE ON public.fiches
  FOR EACH ROW
  EXECUTE FUNCTION notify_fiche_completed();
```

### **Payload Re√ßu par Make**

```json
{
  "id": "cc23d9bb-8f62-4a8b-b230-c7496b881606",
  "nom": "Bien 1137", 
  "statut": "Compl√©t√©",
  "created_at": "2025-07-10T19:00:00Z",
  "updated_at": "2025-07-10T21:00:00Z",
  
  "proprietaire": {
    "prenom": "Maryse",
    "nom": "ROCHER", 
    "email": "maryse.rocher@email.com",
    "adresse_rue": "123 Rue Example",
    "adresse_ville": "Nice"
  },
  
  "logement": {
    "numero_bien": "1137",
    "type_propriete": "Appartement",
    "surface": 85,
    "typologie": "T3",
    "nombre_personnes_max": "6",
    "nombre_lits": "3"
  },
  
  "pdfs": {
    "logement_url": "https://xyz.supabase.co/storage/v1/object/public/fiche-pdfs/fiche-logement-1137.pdf",
    "menage_url": "https://xyz.supabase.co/storage/v1/object/public/fiche-pdfs/fiche-menage-1137.pdf"
  },
  
  "media": {
    "clefs_photos": ["https://xyz.supabase.co/.../clefs_photo1.png"],
    "equipements_poubelle_photos": ["https://xyz.supabase.co/.../poubelle.png"],
    "linge_photos_linge": ["https://xyz.supabase.co/.../linge1.png"],
    "chambres_chambre_1_photos": ["https://xyz.supabase.co/.../chambre1.png"],
    "salle_de_bain_1_photos": ["https://xyz.supabase.co/.../sdb1.png"],
    "cuisine1_cuisiniere_photo": ["https://xyz.supabase.co/.../cuisiniere.png"],
    "securite_photos_equipements": ["https://xyz.supabase.co/.../securite1.png"],
    // ... 39 champs photos au total
  }
}
```

---

## üìÅ **ORGANISATION GOOGLE DRIVE (√Ä CONFIGURER DANS MAKE)**

### **Structure finale recommand√©e**
```
üìÅ 2. DOSSIERS PROPRIETAIRES/
‚îú‚îÄ‚îÄ üìÅ 5566. Florence TEISSIER - Saint Pons/
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ 1. PHOTOS COMMERCIAL/
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ 2. INFORMATIONS PROPRIETAIRE/
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ 3. INFORMATIONS LOGEMENT/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ 1. Fiche logement/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ 2. Photos Visite Logement/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ 3. Acc√®s au logement/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ Photos d'acc√®s/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÅ Vid√©os d'acc√®s/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ 4. Tour g√©n√©rale du logement/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìÅ 5. Tuto √©quipements/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìÅ 6. Identifiants Wifi/
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ 4. PHOTOS ANNONCE/
‚îî‚îÄ‚îÄ üìÅ 1280. Autre propri√©taire - Autre ville/
```

## üìÅ **MAPPING LOGIQUE PHOTOS ‚Üí DOSSIERS DRIVE**
### **Structure finale valid√©e**
```

üìÅ 1. Fiche logement et m√©nage
- Fiche-logement-num de bien.pdf
- Fiche-m√©nage-num de bien.pdf

üìÅ 2. Photos Visite Logement
- chambres_chambre_1_photos ‚Üí chambres_chambre_6_photos
- salle_de_bain_1_photos ‚Üí salle_de_bain_6_photos  
- salon_sam_photos
- cuisine2_photos_tiroirs_placards
- exterieur_photos_espaces
- communs_photos_espaces

üìÅ 3. Acc√®s au logement
- guide_acces_photos_etapes (photos guide d'acc√®s)
- guide_acces_video_acces (vid√©o guide d'acc√®s)

üìÅ 4. Tour g√©n√©rale du logement
-> Vid√©o g√©n√©rale du logement (Ajouter champ vid√©o dans FicheVisite.jsx)

üìÅ 5. Tuto √©quipements
- clefs_emplacement_photo (emplacement bo√Æte √† clefs)
- clefs_interphone_photo  
- clefs_tempo_gache_photo
- clefs_digicode_photo
- clefs_photos (clefs physiques)
- equipements_poubelle_photos
- equipements_disjoncteur_photos  
- equipements_vanne_eau_photos
- equipements_chauffage_eau_photos
- cuisine1_cuisiniere_photo
- cuisine1_plaque_cuisson_photo
- cuisine1_four_photo
- cuisine1_micro_ondes_photo
- cuisine1_lave_vaisselle_photo
- cuisine1_cafetiere_photo
- linge_photos_linge
- linge_emplacement_photos
- jacuzzi_photos_jacuzzi
- barbecue_photos
- bebe_photos_equipements
- securite_photos_equipements
```

Total : 39 champs ‚úÖ

---

## ‚ö° **TESTS VALID√âS - SUCC√àS COMPLET**

### **‚úÖ Test Fiche 7755 - Workflow Complet**

**1. Cr√©ation fiche :**
- ‚úÖ Nouvelle fiche "Bien 7755" cr√©√©e
- ‚úÖ Remplissage sections avec photos multiple
- ‚úÖ Upload photos dans 6 sections diff√©rentes

**2. G√©n√©ration PDF :**
- ‚úÖ Bouton "G√©n√©rer PDF automatique"
- ‚úÖ 2 PDF cr√©√©s : fiche-logement-7755.pdf + fiche-menage-7755.pdf
- ‚úÖ Upload automatique Supabase Storage

**3. Finalisation :**
- ‚úÖ Bouton "Finaliser la fiche" 
- ‚úÖ Statut chang√© : Brouillon ‚Üí Compl√©t√©
- ‚úÖ Trigger webhook d√©clench√© **une seule fois**

**4. Make.com :**
- ‚úÖ Payload optimis√© re√ßu
- ‚úÖ URLs photos + PDF accessibles
- ‚úÖ Module HTTP t√©l√©charge fichiers

---

## üîß **MODULES MAKE CONFIGUR√âS**

### **‚úÖ Modules Op√©rationnels**
1. **Webhook** ‚Üí R√©ception payload ‚úÖ
2. **HTTP GET PDF** ‚Üí T√©l√©chargement fiche-logement.pdf ‚úÖ
3. **Filter** ‚Üí Statut = "Compl√©t√©" (s√©curit√©) ‚úÖ

### **‚úÖ Modules √Ä Ajouter**
4. **HTTP GET PDF M√©nage** ‚Üí T√©l√©chargement fiche-menage.pdf
5. **Google Drive Create Folder** ‚Üí Arborescence automatique
6. **Repeater** ‚Üí Boucle sur chaque section photos
7. **HTTP GET Photos** ‚Üí T√©l√©chargement chaque image
8. **Google Drive Upload** ‚Üí Organisation finale Drive

---

*üìÖ Derni√®re mise √† jour : 18 juillet 2025*  
*üë§ D√©veloppeurs : Julien + Claude Sonnet 4*  
*üéØ Statut : ‚úÖ WEBHOOK COMPLET + PHOTOS OP√âRATIONNELS - Pr√™t pour finalisation Drive*  
*üìà Version : 7.0 - Payload complet pour tests facilit√©s*