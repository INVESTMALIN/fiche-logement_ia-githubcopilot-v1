# ğŸ› Bug Report - Fiche Logement

*Historique des bugs rencontrÃ©s et leurs solutions*

---

## ğŸš¨ **BUG #001 - Affichage Boutons Radio sur iPhone**
**Date :** 11 juillet 2025  
**GravitÃ© :** Faible  
**Statut :** âœ… RÃ‰SOLU  

Les boutons radio ne s'affichent pas correctement sur **iPhone** (testÃ© sur iPhone 12) :
- Les labels sont dÃ©calÃ©s vers la droite et sortent de la page au lieu d'Ãªtre collÃ©s aux boutons
- L'alignement est cassÃ© spÃ©cifiquement sur iOS
- **Android et Desktop** : âœ… Fonctionnent correctement

### **Cause du Bug**
ProblÃ¨me de CSS spÃ©cifique iOS avec la combinaison :
- `inline-flex` sur les labels
- Classes CSS custom au lieu de dimensions fixes
- Structure HTML non optimale pour iOS

### **Solution TestÃ©e et ValidÃ©e**

#### âŒ **Pattern Buggy (Ã  corriger)**
```javascript
<div className="flex gap-6">
  <label className="inline-flex items-center gap-2 cursor-pointer">
    <input 
      type="radio" 
      className="text-primary focus:ring-primary"
    />
    Texte label
  </label>
</div>
```

#### âœ… **Pattern Correct (Ã  utiliser)**
```javascript
<div className="flex flex-col gap-2">  {/* ou flex gap-6 pour horizontal */}
  <label className="flex items-center gap-2 cursor-pointer">
    <input 
      type="radio" 
      className="w-4 h-4 cursor-pointer"
    />
    <span>Texte label</span>
  </label>
</div>
```

### **Changements Obligatoires**
1. **Label** : `inline-flex` â†’ `flex`
2. **Input** : `text-primary focus:ring-primary` â†’ `w-4 h-4 cursor-pointer`
3. **Texte** : Texte direct â†’ `<span>Texte</span>`

---

## ğŸš¨ **BUG #002 - Trigger Webhook ne fonctionne pas**
**Date :** 14 juillet 2025  
**GravitÃ© :** Critique  
**Statut :** âœ… RÃ‰SOLU  

### **SymptÃ´mes**
- Bouton "Finaliser la fiche" ne change pas le statut (reste en "Brouillon")
- Erreur console : `PATCH 404 (Not Found)` ou `400 (Bad Request)`
- Erreur Supabase : `function supabase_functions.http_request(...) does not exist`
- Trigger webhook ne se dÃ©clenche pas

### **Cause racine**
Syntaxe incorrecte pour l'appel HTTP dans le trigger SQL Supabase. Plusieurs fonctions testÃ©es :
- âŒ `supabase_functions.http_request()` â†’ N'existe pas
- âŒ `net.http_post()` avec syntaxe positionnelle â†’ Erreur de type  
- âœ… `net.http_post()` avec syntaxe nommÃ©e â†’ **FONCTIONNE**

### **Solution finale**
```sql
-- Supprimer l'ancien trigger dÃ©faillant
DROP TRIGGER IF EXISTS fiche_completed_webhook ON public.fiches;
DROP FUNCTION IF EXISTS notify_fiche_completed();

-- CrÃ©er la fonction avec la syntaxe correcte
CREATE OR REPLACE FUNCTION notify_fiche_completed()
RETURNS trigger AS $$
BEGIN
  -- Seulement si statut passe Ã  "ComplÃ©tÃ©"
  IF NEW.statut = 'ComplÃ©tÃ©' AND (OLD.statut IS NULL OR OLD.statut != 'ComplÃ©tÃ©') THEN
    PERFORM net.http_post(
      url := 'https://hook.eu2.make.com/ydjwftmd7czs4rygv1rjhi6u4pvb4gdj',
      body := to_jsonb(NEW),
      headers := '{"Content-Type": "application/json"}'::jsonb
    );
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- RecrÃ©er le trigger
CREATE TRIGGER fiche_completed_webhook
  AFTER UPDATE ON public.fiches
  FOR EACH ROW
  EXECUTE FUNCTION notify_fiche_completed();
```

### **Points clÃ©s de la solution**
1. **Syntaxe nommÃ©e** : `url :=`, `body :=`, `headers :=` 
2. **Fonction correcte** : `net.http_post` (pas `supabase_functions.http_request`)
3. **Headers format** : `'{"Content-Type": "application/json"}'::jsonb`
4. **Body format** : `to_jsonb(NEW)` pour convertir la ligne en JSON

### **Tests validÃ©s**
- âœ… Bouton "Finaliser" change le statut vers "ComplÃ©tÃ©"
- âœ… Trigger se dÃ©clenche uniquement sur changement de statut (pas doublons)
- âœ… Webhook Make reÃ§oit payload complet (~750 colonnes)
- âœ… Pas d'erreur console

---

## ğŸš¨ **BUG #003 - Champs input perdent focus Ã  chaque frappe**
**Date :** 15 juillet 2025  
**GravitÃ© :** Majeure  
**Statut :** âœ… RÃ‰SOLU  

### **SymptÃ´mes**
- Dans `FicheEquipExterieur.jsx`, champs "FrÃ©quence d'entretien" et "Type de prestation" se rÃ©initialisent Ã  chaque frappe
- L'utilisateur ne peut taper qu'une lettre Ã  la fois, doit recliquer dans le champ
- Bug prÃ©sent sur tous les champs conditionnels imbriquÃ©s (extÃ©rieur, piscine, jacuzzi, cuisine extÃ©rieure)
- MÃªme problÃ¨me rÃ©solu prÃ©cÃ©demment sur FicheChambre et FicheSalleDeBains

### **Cause racine**
Composant `EntretienPattern` dÃ©fini **Ã  l'intÃ©rieur** de la fonction `FicheEquipExterieur()`, causant :
- Re-crÃ©ation du composant Ã  chaque render
- Perte de rÃ©fÃ©rence React
- RÃ©initialisation des inputs

### **Solution finale**
```javascript
// âœ… AVANT - Sortir le composant EntretienPattern HORS de la fonction principale
const EntretienPattern = ({ prefix, label, formData, getField, handleInputChange, handleRadioChange }) => {
  const entretienField = `${prefix}_entretien_prestataire`
  const entretienValue = formData[entretienField.split('.').pop()]
  
  return (
    <div className="space-y-4">
      {/* Contenu du composant... */}
    </div>
  )
}

// âœ… APRÃˆS - Dans la fonction principale, passer toutes les props nÃ©cessaires
export default function FicheEquipExterieur() {
  // ...fonctions...
  
  return (
    <EntretienPattern 
      prefix="section_equip_spe_exterieur.exterieur" 
      label="de l'extÃ©rieur"
      formData={formData}
      getField={getField}
      handleInputChange={handleInputChange}
      handleRadioChange={handleRadioChange}
    />
  )
}
```

### **Changements requis**
1. **DÃ©placer** `EntretienPattern` avant `export default function FicheEquipExterieur()`
2. **Ajouter** les props : `formData`, `getField`, `handleInputChange`, `handleRadioChange`
3. **Modifier** les 4 appels du composant pour passer ces props
4. **Supprimer** l'ancien composant de l'intÃ©rieur de la fonction

### **Tests validÃ©s**
- âœ… Frappe continue possible dans "FrÃ©quence d'entretien"
- âœ… Frappe continue possible dans "Type de prestation" 
- âœ… Pas de perte de focus sur les 4 sections (extÃ©rieur, piscine, jacuzzi, cuisine ext.)
- âœ… FonctionnalitÃ© conditionnelle intacte

---

## ğŸš¨ **BUG #004 - Champs conditionnels gardent valeurs fantÃ´mes**
**Date :** 15 juillet 2025  
**GravitÃ© :** Mineure  
**Statut :** âœ… RÃ‰SOLU  

### **SymptÃ´mes**
- Dans `FicheBebe.jsx`, aprÃ¨s avoir cochÃ© "Lit bÃ©bÃ©" puis choisi un type, si on dÃ©coche "Lit bÃ©bÃ©" :
  - Les champs conditionnels disparaissent visuellement âœ…
  - Mais les valeurs restent stockÃ©es dans FormContext âŒ
- MÃªme problÃ¨me pour "Chaise haute", "Jouets pour enfants", etc.
- Valeurs "fantÃ´mes" invisibles mais prÃ©sentes dans les donnÃ©es

### **Cause racine**
La fonction `handleArrayCheckboxChange` ne nettoie que l'array principal, pas les champs liÃ©s conditionnels.

### **Solution finale**
```javascript
// âœ… Fonction modifiÃ©e avec nettoyage automatique
const handleArrayCheckboxChange = (field, option, checked) => {
  const currentArray = formData[field.split('.').pop()] || []
  let newArray
  if (checked) {
    newArray = [...currentArray, option]
  } else {
    newArray = currentArray.filter(item => item !== option)
    
    // ğŸ†• NETTOYAGE AUTOMATIQUE des champs liÃ©s quand on dÃ©coche
    if (option === 'Lit bÃ©bÃ©') {
      // Nettoyer tous les champs liÃ©s au lit bÃ©bÃ©
      updateField('section_bebe.lit_bebe_type', '')
      updateField('section_bebe.lit_parapluie_disponibilite', '')
      updateField('section_bebe.lit_stores_occultants', null)
    }
    
    if (option === 'Chaise haute') {
      // Nettoyer tous les champs liÃ©s Ã  la chaise haute
      updateField('section_bebe.chaise_haute_type', '')
      updateField('section_bebe.chaise_haute_disponibilite', '')
      updateField('section_bebe.chaise_haute_caracteristiques', [])
      updateField('section_bebe.chaise_haute_prix', '')
    }
    
    if (option === 'Jouets pour enfants') {
      updateField('section_bebe.jouets_tranches_age', [])
    }
    
    if (option === 'Autre') {
      updateField('section_bebe.equipements_autre_details', '')
    }
  }
  
  updateField(field, newArray)
}
```

### **Tests validÃ©s**
- âœ… Cocher "Lit bÃ©bÃ©" â†’ choisir type â†’ dÃ©cocher "Lit bÃ©bÃ©" â†’ champs effacÃ©s
- âœ… MÃªme comportement pour "Chaise haute" et "Jouets"
- âœ… Plus de valeurs fantÃ´mes dans FormContext
- âœ… Interface cohÃ©rente avec les donnÃ©es

### **Applications potentielles**
Ce pattern peut Ãªtre appliquÃ© Ã  d'autres sections avec champs conditionnels similaires.

---

## ğŸ”§ **Template pour nouveaux bugs**

```markdown
## ğŸš¨ **BUG #XXX - Titre du bug**
**Date :** JJ/MM/AAAA  
**GravitÃ© :** Critique/Majeure/Mineure  
**Statut :** ğŸ”„ EN COURS / âœ… RÃ‰SOLU / âŒ NON RÃ‰SOLU  

### **SymptÃ´mes**
- Comportement observÃ©
- Messages d'erreur exacts
- Actions qui ne fonctionnent pas

### **Cause racine**
Explication technique du problÃ¨me

### **Solution finale**
```code
Code de la solution qui fonctionne
```

### **Tests validÃ©s**
- âœ… Test 1
- âœ… Test 2

### **PrÃ©vention**
- âš ï¸ Points d'attention pour Ã©viter le problÃ¨me
```

---

*ğŸ“ Maintenez ce fichier Ã  jour Ã  chaque bug critique rencontrÃ©*