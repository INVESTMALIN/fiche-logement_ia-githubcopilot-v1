# üêõ Bug Report - Fiche Logement

*Historique des bugs rencontr√©s et leurs solutions*

---

## üö® **BUG #001 - Affichage Boutons Radio sur iPhone**
**Date :** 11 juillet 2025  
**Gravit√© :** Low  
**Statut :** ‚úÖ R√âSOLU  

Les boutons radio ne s'affichent pas correctement sur **iPhone** (test√© sur iPhone 12) :
- Les labels sont d√©cal√©s vers la droite et sortent de la page au lieu d'√™tre coll√©s aux boutons
- L'alignement est cass√© sp√©cifiquement sur iOS
- **Android et Desktop** : ‚úÖ Fonctionnent correctement

### **Cause du Bug**
Probl√®me de CSS sp√©cifique iOS avec la combinaison :
- `inline-flex` sur les labels
- Classes CSS custom au lieu de dimensions fixes
- Structure HTML non optimale pour iOS

### **Solution Test√©e et Valid√©e**

#### ‚ùå **Pattern Buggy (√† corriger)**
```javascript
<div className="flex gap-6">
  <label className="inline-flex items-center gap-2 cursor-pointer">
    <input 
      type="radio" 
      className="text-primary focus:ring-primary"
    />
    Texte label
  </label>
</div>
```

#### ‚úÖ **Pattern Correct (√† utiliser)**
```javascript
<div className="flex flex-col gap-2">  {/* ou flex gap-6 pour horizontal */}
  <label className="flex items-center gap-2 cursor-pointer">
    <input 
      type="radio" 
      className="w-4 h-4 cursor-pointer"
    />
    <span>Texte label</span>
  </label>
</div>
```

### **Changements Obligatoires**
1. **Label** : `inline-flex` ‚Üí `flex`
2. **Input** : `text-primary focus:ring-primary` ‚Üí `w-4 h-4 cursor-pointer`
3. **Texte** : Texte direct ‚Üí `<span>Texte</span>`

---

## üö® **BUG #002 - Trigger Webhook ne fonctionne pas**
**Date :** 14 juillet 2025  
**Gravit√© :** Critique  
**Statut :** ‚úÖ R√âSOLU  

### **Sympt√¥mes**
- Bouton "Finaliser la fiche" ne change pas le statut (reste en "Brouillon")
- Erreur console : `PATCH 404 (Not Found)` ou `400 (Bad Request)`
- Erreur Supabase : `function supabase_functions.http_request(...) does not exist`
- Trigger webhook ne se d√©clenche pas

### **Cause racine**
Syntaxe incorrecte pour l'appel HTTP dans le trigger SQL Supabase. Plusieurs fonctions test√©es :
- ‚ùå `supabase_functions.http_request()` ‚Üí N'existe pas
- ‚ùå `net.http_post()` avec syntaxe positionnelle ‚Üí Erreur de type  
- ‚úÖ `net.http_post()` avec syntaxe nomm√©e ‚Üí **FONCTIONNE**

### **Solution finale**
```sql
-- Supprimer l'ancien trigger d√©faillant
DROP TRIGGER IF EXISTS fiche_completed_webhook ON public.fiches;
DROP FUNCTION IF EXISTS notify_fiche_completed();

-- Cr√©er la fonction avec la syntaxe correcte
CREATE OR REPLACE FUNCTION notify_fiche_completed()
RETURNS trigger AS $$
BEGIN
  -- Seulement si statut passe √† "Compl√©t√©"
  IF NEW.statut = 'Compl√©t√©' AND (OLD.statut IS NULL OR OLD.statut != 'Compl√©t√©') THEN
    PERFORM net.http_post(
      url := 'https://hook.eu2.make.com/ydjwftmd7czs4rygv1rjhi6u4pvb4gdj',
      body := to_jsonb(NEW),
      headers := '{"Content-Type": "application/json"}'::jsonb
    );
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Recr√©er le trigger
CREATE TRIGGER fiche_completed_webhook
  AFTER UPDATE ON public.fiches
  FOR EACH ROW
  EXECUTE FUNCTION notify_fiche_completed();
```

### **Points cl√©s de la solution**
1. **Syntaxe nomm√©e** : `url :=`, `body :=`, `headers :=` 
2. **Fonction correcte** : `net.http_post` (pas `supabase_functions.http_request`)
3. **Headers format** : `'{"Content-Type": "application/json"}'::jsonb`
4. **Body format** : `to_jsonb(NEW)` pour convertir la ligne en JSON

### **Tests valid√©s**
- ‚úÖ Bouton "Finaliser" change le statut vers "Compl√©t√©"
- ‚úÖ Trigger se d√©clenche uniquement sur changement de statut (pas doublons)
- ‚úÖ Webhook Make re√ßoit payload complet (~750 colonnes)
- ‚úÖ Pas d'erreur console

---

## üö® **BUG #003 - Champs input perdent focus √† chaque frappe**
**Date :** 15 juillet 2025  
**Gravit√© :** Majeure  
**Statut :** ‚úÖ R√âSOLU  

### **Sympt√¥mes**
- Dans `FicheEquipExterieur.jsx`, champs "Fr√©quence d'entretien" et "Type de prestation" se r√©initialisent √† chaque frappe
- L'utilisateur ne peut taper qu'une lettre √† la fois, doit recliquer dans le champ
- Bug pr√©sent sur tous les champs conditionnels imbriqu√©s (ext√©rieur, piscine, jacuzzi, cuisine ext√©rieure)
- M√™me probl√®me r√©solu pr√©c√©demment sur FicheChambre et FicheSalleDeBains

### **Cause racine**
Composant `EntretienPattern` d√©fini **√† l'int√©rieur** de la fonction `FicheEquipExterieur()`, causant :
- Re-cr√©ation du composant √† chaque render
- Perte de r√©f√©rence React
- R√©initialisation des inputs

### **Solution finale**
```javascript
// ‚úÖ AVANT - Sortir le composant EntretienPattern HORS de la fonction principale
const EntretienPattern = ({ prefix, label, formData, getField, handleInputChange, handleRadioChange }) => {
  const entretienField = `${prefix}_entretien_prestataire`
  const entretienValue = formData[entretienField.split('.').pop()]
  
  return (
    <div className="space-y-4">
      {/* Contenu du composant... */}
    </div>
  )
}

// ‚úÖ APR√àS - Dans la fonction principale, passer toutes les props n√©cessaires
export default function FicheEquipExterieur() {
  // ...fonctions...
  
  return (
    <EntretienPattern 
      prefix="section_equip_spe_exterieur.exterieur" 
      label="de l'ext√©rieur"
      formData={formData}
      getField={getField}
      handleInputChange={handleInputChange}
      handleRadioChange={handleRadioChange}
    />
  )
}
```

### **Changements requis**
1. **D√©placer** `EntretienPattern` avant `export default function FicheEquipExterieur()`
2. **Ajouter** les props : `formData`, `getField`, `handleInputChange`, `handleRadioChange`
3. **Modifier** les 4 appels du composant pour passer ces props
4. **Supprimer** l'ancien composant de l'int√©rieur de la fonction

### **Tests valid√©s**
- ‚úÖ Frappe continue possible dans "Fr√©quence d'entretien"
- ‚úÖ Frappe continue possible dans "Type de prestation" 
- ‚úÖ Pas de perte de focus sur les 4 sections (ext√©rieur, piscine, jacuzzi, cuisine ext.)
- ‚úÖ Fonctionnalit√© conditionnelle intacte

---

## üö® **BUG #004 - Champs conditionnels gardent valeurs fant√¥mes**
**Date :** 15 juillet 2025  
**Gravit√© :** High
**Statut :** ‚úÖ R√âSOLU  

### **Sympt√¥mes**
- Dans `FicheBebe.jsx`, apr√®s avoir coch√© "Lit b√©b√©" puis choisi un type, si on d√©coche "Lit b√©b√©" :
  - Les champs conditionnels disparaissent visuellement ‚úÖ
  - Mais les valeurs restent stock√©es dans FormContext ‚ùå
- M√™me probl√®me pour "Chaise haute", "Jouets pour enfants", etc.
- Valeurs "fant√¥mes" invisibles mais pr√©sentes dans les donn√©es

### **Cause racine**
La fonction `handleArrayCheckboxChange` ne nettoie que l'array principal, pas les champs li√©s conditionnels.

### **Solution finale**
```javascript
// ‚úÖ Fonction modifi√©e avec nettoyage automatique
const handleArrayCheckboxChange = (field, option, checked) => {
  const currentArray = formData[field.split('.').pop()] || []
  let newArray
  if (checked) {
    newArray = [...currentArray, option]
  } else {
    newArray = currentArray.filter(item => item !== option)
    
    // üÜï NETTOYAGE AUTOMATIQUE des champs li√©s quand on d√©coche
    if (option === 'Lit b√©b√©') {
      // Nettoyer tous les champs li√©s au lit b√©b√©
      updateField('section_bebe.lit_bebe_type', '')
      updateField('section_bebe.lit_parapluie_disponibilite', '')
      updateField('section_bebe.lit_stores_occultants', null)
    }
    
    if (option === 'Chaise haute') {
      // Nettoyer tous les champs li√©s √† la chaise haute
      updateField('section_bebe.chaise_haute_type', '')
      updateField('section_bebe.chaise_haute_disponibilite', '')
      updateField('section_bebe.chaise_haute_caracteristiques', [])
      updateField('section_bebe.chaise_haute_prix', '')
    }
    
    if (option === 'Jouets pour enfants') {
      updateField('section_bebe.jouets_tranches_age', [])
    }
    
    if (option === 'Autre') {
      updateField('section_bebe.equipements_autre_details', '')
    }
  }
  
  updateField(field, newArray)
}
```

### **Tests valid√©s**
- ‚úÖ Cocher "Lit b√©b√©" ‚Üí choisir type ‚Üí d√©cocher "Lit b√©b√©" ‚Üí champs effac√©s
- ‚úÖ M√™me comportement pour "Chaise haute" et "Jouets"
- ‚úÖ Plus de valeurs fant√¥mes dans FormContext
- ‚úÖ Interface coh√©rente avec les donn√©es

### **Applications potentielles**
Ce pattern peut √™tre appliqu√© √† d'autres sections avec champs conditionnels similaires.

---

## üö® **BUG #004 - Payload Make ing√©rable (750 colonnes)**
**Date :** 16 juillet 2025  
**Gravit√© :** Medium  
**Statut :** ‚úÖ R√âSOLU  

### **Sympt√¥mes**
- Webhook Make re√ßoit 750+ colonnes de la table Supabase
- Impossible de mapper manuellement tous les champs dans Make
- Interface Make devient inutilisable
- Champs photos perdus dans la masse de donn√©es
- Workflow Drive impossible √† configurer

### **Cause racine**
Trigger SQL utilise `to_jsonb(NEW)` qui envoie **TOUTE** la ligne de la table `fiches` sans structure ni filtrage :
```sql
-- ‚ùå PROBL√âMATIQUE
body := to_jsonb(NEW),  -- Envoie les 750+ colonnes en vrac
```

### **Solution finale - Payload optimis√© structur√©**
```sql
-- ‚úÖ NOUVEAU TRIGGER OPTIMIS√â
-- üéØ Payload optimis√© avec TOUS les champs essentiels
CREATE OR REPLACE FUNCTION public.notify_fiche_completed()
RETURNS trigger
LANGUAGE plpgsql
AS $function$
BEGIN
  IF NEW.statut = 'Compl√©t√©' THEN
    PERFORM net.http_post(
      url := 'https://hook.eu2.make.com/ydjwftmd7czs4rygv1rjhi6u4pvb4gdj',
      body := jsonb_build_object(
        -- üìã M√âTADONN√âES
        'id', NEW.id,
        'nom', NEW.nom,
        'statut', NEW.statut,
        'created_at', NEW.created_at,
        'updated_at', NEW.updated_at,
        
        -- üë§ PROPRI√âTAIRE
        'proprietaire', jsonb_build_object(
          'prenom', NEW.proprietaire_prenom,
          'nom', NEW.proprietaire_nom,
          'email', NEW.proprietaire_email,
          'adresse_rue', NEW.proprietaire_adresse_rue,
          'adresse_complement', NEW.proprietaire_adresse_complement,
          'adresse_ville', NEW.proprietaire_adresse_ville,
          'adresse_code_postal', NEW.proprietaire_adresse_code_postal
        ),
        
        -- üè† LOGEMENT
        'logement', jsonb_build_object(
          'numero_bien', NEW.logement_numero_bien,
          'type_propriete', NEW.logement_type_propriete,
          'typologie', NEW.logement_typologie,
          'surface', NEW.logement_surface,
          'nombre_personnes_max', NEW.logement_nombre_personnes_max,
          'nombre_lits', NEW.logement_nombre_lits
        ),
        
        -- üìÑ PDF
        'pdfs', jsonb_build_object(
          'logement_url', NEW.pdf_logement_url,
          'menage_url', NEW.pdf_menage_url
        ),
        
        -- üì∏ TOUTES LES PHOTOS ET VID√âOS (29 champs)
        'media', jsonb_build_object(
          -- Section Clefs (5 champs)
          'clefs_emplacement_photo', NEW.clefs_emplacement_photo,
          'clefs_interphone_photo', NEW.clefs_interphone_photo,
          'clefs_tempo_gache_photo', NEW.clefs_tempo_gache_photo,
          'clefs_digicode_photo', NEW.clefs_digicode_photo,
          'clefs_photos', NEW.clefs_photos,
          
          -- Section Equipements (4 champs)
          'equipements_poubelle_photos', NEW.equipements_poubelle_photos,
          'equipements_disjoncteur_photos', NEW.equipements_disjoncteur_photos,
          'equipements_vanne_eau_photos', NEW.equipements_vanne_eau_photos,
          'equipements_chauffage_eau_photos', NEW.equipements_chauffage_eau_photos,
          
          -- Section Gestion Linge (2 champs)
          'linge_photos_linge', NEW.linge_photos_linge,
          'linge_emplacement_photos', NEW.linge_emplacement_photos,
          
          -- Section Chambres (6 champs)
          'chambres_chambre_1_photos', NEW.chambres_chambre_1_photos_chambre,
          'chambres_chambre_2_photos', NEW.chambres_chambre_2_photos_chambre,
          'chambres_chambre_3_photos', NEW.chambres_chambre_3_photos_chambre,
          'chambres_chambre_4_photos', NEW.chambres_chambre_4_photos_chambre,
          'chambres_chambre_5_photos', NEW.chambres_chambre_5_photos_chambre,
          'chambres_chambre_6_photos', NEW.chambres_chambre_6_photos_chambre,
          
          -- Section Salles de Bains (6 champs)
          'salle_de_bain_1_photos', NEW.salle_de_bains_salle_de_bain_1_photos_salle_de_bain,
          'salle_de_bain_2_photos', NEW.salle_de_bains_salle_de_bain_2_photos_salle_de_bain,
          'salle_de_bain_3_photos', NEW.salle_de_bains_salle_de_bain_3_photos_salle_de_bain,
          'salle_de_bain_4_photos', NEW.salle_de_bains_salle_de_bain_4_photos_salle_de_bain,
          'salle_de_bain_5_photos', NEW.salle_de_bains_salle_de_bain_5_photos_salle_de_bain,
          'salle_de_bain_6_photos', NEW.salle_de_bains_salle_de_bain_6_photos_salle_de_bain,
          
          -- Section Cuisines (7 champs)
          'cuisine1_cuisiniere_photo', NEW.cuisine_1_cuisiniere_photo,
          'cuisine1_plaque_cuisson_photo', NEW.cuisine_1_plaque_cuisson_photo,
          'cuisine1_four_photo', NEW.cuisine_1_four_photo,
          'cuisine1_micro_ondes_photo', NEW.cuisine_1_micro_ondes_photo,
          'cuisine1_lave_vaisselle_photo', NEW.cuisine_1_lave_vaisselle_photo,
          'cuisine1_cafetiere_photo', NEW.cuisine_1_cafetiere_photo,
          'cuisine2_photos_tiroirs_placards', NEW.cuisine_2_photos_tiroirs_placards,
          
          -- Section Salon/SAM (1 champ)
          'salon_sam_photos', NEW.salon_sam_photos_salon_sam,
          
          -- Section √âquipements Sp√©ciaux/Ext√©rieur (3 champs)
          'exterieur_photos_espaces', NEW.equip_spe_ext_exterieur_photos,
          'jacuzzi_photos_jacuzzi', NEW.equip_spe_ext_jacuzzi_photos,
          'barbecue_photos', NEW.equip_spe_ext_barbecue_photos,
          
          -- Section Communs (1 champ)
          'communs_photos_espaces', NEW.communs_photos_espaces_communs,
          
          -- Section B√©b√© (1 champ)
          'bebe_photos_equipements', NEW.bebe_photos_equipements_bebe,
          
          -- Section Guide d'acc√®s (2 champs)
          'guide_acces_photos_etapes', NEW.guide_acces_photos_etapes,
          'guide_acces_video_acces', NEW.guide_acces_video_acces,
          
          -- Section S√©curit√© (1 champ)
          'securite_photos_equipements', NEW.securite_photos_equipements_securite
        )
      ),
      headers := '{"Content-Type": "application/json"}'::jsonb
    );
  END IF;
  RETURN NEW;
END;
$function$;
```

### **R√©sultats obtenus**
- ‚úÖ **29 champs cibl√©s** au lieu de 750+ colonnes
- ‚úÖ **Structure logique** : metadata ‚Üí proprietaire ‚Üí logement ‚Üí pdfs ‚Üí media
- ‚úÖ **Interface Make utilisable** : mapping simple et intuitif
- ‚úÖ **Toutes les photos/vid√©os pr√©sentes** et organis√©es par section
- ‚úÖ **Workflow Drive configurable** facilement
- ‚úÖ **Performance optimis√©e** pour Make

### **Impact Business**
- **Temps configuration Make** : 3h ‚Üí 30min
- **Maintenance** : Aucune modification n√©cessaire pour nouveaux champs photos
- **Workflow Drive** : Organisation automatique par section possible
- **√âvolutivit√©** : Structure extensible sans casser l'existant

---

## üîß **Template pour nouveaux bugs**

```markdown
## üö® **BUG #XXX - Titre du bug**
**Date :** JJ/MM/AAAA  
**Gravit√© :** Critique/Majeure/Mineure  
**Statut :** üîÑ EN COURS / ‚úÖ R√âSOLU / ‚ùå NON R√âSOLU  

### **Sympt√¥mes**
- Comportement observ√©
- Messages d'erreur exacts
- Actions qui ne fonctionnent pas

### **Cause racine**
Explication technique du probl√®me

### **Solution finale**
```code
Code de la solution qui fonctionne
```

### **Tests valid√©s**
- ‚úÖ Test 1
- ‚úÖ Test 2

### **Pr√©vention**
- ‚ö†Ô∏è Points d'attention pour √©viter le probl√®me
```

---

*üìù Maintenez ce fichier √† jour √† chaque bug critique rencontr√©*