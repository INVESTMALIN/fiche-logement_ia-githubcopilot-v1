# ğŸ› Bug Report - Boutons Radio iPhone

*Historique des bugs rencontrÃ©s et leurs solutions*


## ğŸš¨ **BUG #001 -Affichage Boutons Radio sur iPhone**
**Date :** 11 juillet 2025  
**GravitÃ© :** Faible  
**Statut :** âœ… RÃ‰SOLU  

Les boutons radio ne s'affichent pas correctement sur **iPhone** (testÃ© sur iPhone 12) :
- Les labels sont dÃ©calÃ©s vers la droite et sortent de la page au lieu d'Ãªtre collÃ©s aux boutons
- L'alignement est cassÃ© spÃ©cifiquement sur iOS
- **Android et Desktop** : âœ… Fonctionnent correctement

## ğŸ” **Cause du Bug**

ProblÃ¨me de CSS spÃ©cifique iOS avec la combinaison :
- `inline-flex` sur les labels
- Classes CSS custom au lieu de dimensions fixes
- Structure HTML non optimale pour iOS

## âœ… **Solution TestÃ©e et ValidÃ©e**

### âŒ **Pattern Buggy (Ã  corriger)**
```javascript
<div className="flex gap-6">
  <label className="inline-flex items-center gap-2 cursor-pointer">
    <input 
      type="radio" 
      className="text-primary focus:ring-primary"
    />
    Texte label
  </label>
</div>
```

### âœ… **Pattern Correct (Ã  utiliser)**
```javascript
<div className="flex flex-col gap-2">  {/* ou flex gap-6 pour horizontal */}
  <label className="flex items-center gap-2 cursor-pointer">
    <input 
      type="radio" 
      className="w-4 h-4 cursor-pointer"
    />
    <span>Texte label</span>
  </label>
</div>
```

## ğŸ¯ **Changements Obligatoires**

1. **Label** : `inline-flex` â†’ `flex`
2. **Input** : `text-primary focus:ring-primary` â†’ `w-4 h-4 cursor-pointer`
3. **Texte** : Texte direct â†’ `<span>Texte</span>`

## ğŸ“‹ **Pages Ã  Corriger**

### ğŸ”´ **FicheClefs** - âœ… CORRIGÃ‰
- Type de boÃ®te Ã  clÃ©s
- Interphone (Oui/Non)
- Tempo-gÃ¢che (Oui/Non)
- Digicode (Oui/Non)
- Clefs remises (Oui/Non)

### ğŸŸ¡ **Ã€ VÃ©rifier** (potentiellement touchÃ©es)
- **FicheVisite** - A priori OK (utilise dÃ©jÃ  le bon pattern)
- **FicheCuisine1** - A priori OK 
- **Autres sections** avec boutons radio

## ğŸ”§ **Script de Correction Rapide**

Pour corriger rapidement, rechercher et remplacer :

1. **Rechercher** : `inline-flex items-center gap-2 cursor-pointer`
   **Remplacer** : `flex items-center gap-2 cursor-pointer`

2. **Rechercher** : `className="text-primary focus:ring-primary"`
   **Remplacer** : `className="w-4 h-4 cursor-pointer"`

3. **VÃ©rifier manuellement** que les textes sont dans des `<span>`

## ğŸ“š **RÃ©fÃ©rence**

**Pages qui utilisent dÃ©jÃ  le bon pattern :**
- âœ… **FicheAirbnb** 
- âœ… **FicheBooking**

Ces pages peuvent servir de modÃ¨le pour les corrections.

## âš ï¸ **Notes Importantes**

- Le bug est **spÃ©cifique Ã  iOS** - ne pas casser desktop/Android
- Tester systÃ©matiquement sur iPhone aprÃ¨s correction
- Le pattern en colonne (`flex-col`) est plus safe pour mobile
- Garder `cursor-pointer` pour l'UX tactile

---

**Status :** ğŸŸ¢ Solution validÃ©e sur iPhone 12  
**PrioritÃ© :** Faible (impact UX mobile limitÃ©e)

---

## ğŸš¨ **BUG #002 - Trigger Webhook ne fonctionne pas**
**Date :** 14 juillet 2025  
**GravitÃ© :** Critique  
**Statut :** âœ… RÃ‰SOLU  

### **SymptÃ´mes**
- Bouton "Finaliser la fiche" ne change pas le statut (reste en "Brouillon")
- Erreur console : `PATCH 404 (Not Found)` ou `400 (Bad Request)`
- Erreur Supabase : `function supabase_functions.http_request(...) does not exist`
- Trigger webhook ne se dÃ©clenche pas

### **Cause racine**
Syntaxe incorrecte pour l'appel HTTP dans le trigger SQL Supabase. Plusieurs fonctions testÃ©es :
- âŒ `supabase_functions.http_request()` â†’ N'existe pas
- âŒ `net.http_post()` avec syntaxe positionnelle â†’ Erreur de type  
- âœ… `net.http_post()` avec syntaxe nommÃ©e â†’ **FONCTIONNE**

### **Solution finale**
```sql
-- Supprimer l'ancien trigger dÃ©faillant
DROP TRIGGER IF EXISTS fiche_completed_webhook ON public.fiches;
DROP FUNCTION IF EXISTS notify_fiche_completed();

-- CrÃ©er la fonction avec la syntaxe correcte
CREATE OR REPLACE FUNCTION notify_fiche_completed()
RETURNS trigger AS $$
BEGIN
  -- Seulement si statut passe Ã  "ComplÃ©tÃ©"
  IF NEW.statut = 'ComplÃ©tÃ©' AND (OLD.statut IS NULL OR OLD.statut != 'ComplÃ©tÃ©') THEN
    PERFORM net.http_post(
      url := 'https://hook.eu2.make.com/ydjwftmd7czs4rygv1rjhi6u4pvb4gdj',
      body := to_jsonb(NEW),
      headers := '{"Content-Type": "application/json"}'::jsonb
    );
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- RecrÃ©er le trigger
CREATE TRIGGER fiche_completed_webhook
  AFTER UPDATE ON public.fiches
  FOR EACH ROW
  EXECUTE FUNCTION notify_fiche_completed();
```

### **Points clÃ©s de la solution**
1. **Syntaxe nommÃ©e** : `url :=`, `body :=`, `headers :=` 
2. **Fonction correcte** : `net.http_post` (pas `supabase_functions.http_request`)
3. **Headers format** : `'{"Content-Type": "application/json"}'::jsonb`
4. **Body format** : `to_jsonb(NEW)` pour convertir la ligne en JSON

### **Tests validÃ©s**
- âœ… Bouton "Finaliser" change le statut vers "ComplÃ©tÃ©"
- âœ… Trigger se dÃ©clenche uniquement sur changement de statut (pas doublons)
- âœ… Webhook Make reÃ§oit payload complet (~750 colonnes)
- âœ… Pas d'erreur console

### **PrÃ©vention**
- âš ï¸ Toujours utiliser la syntaxe nommÃ©e avec `:=` pour `net.http_post`
- âš ï¸ VÃ©rifier que l'extension `http` est bien activÃ©e : `CREATE EXTENSION IF NOT EXISTS http;`
- âš ï¸ Tester le trigger avec `to_jsonb(NEW)` avant de complexifier le payload

---

## ğŸ”§ **Template pour nouveaux bugs**

```markdown
## ğŸš¨ **BUG #XXX - Titre du bug**
**Date :** JJ/MM/AAAA  
**GravitÃ© :** Critique/Majeure/Mineure  
**Statut :** ğŸ”„ EN COURS / âœ… RÃ‰SOLU / âŒ NON RÃ‰SOLU  

### **SymptÃ´mes**
- Comportement observÃ©
- Messages d'erreur exacts
- Actions qui ne fonctionnent pas

### **Cause racine**
Explication technique du problÃ¨me

### **Solution finale**
```code
Code de la solution qui fonctionne
```

### **Tests validÃ©s**
- âœ… Test 1
- âœ… Test 2

### **PrÃ©vention**
- âš ï¸ Points d'attention pour Ã©viter le problÃ¨me
```

---

*ğŸ“ Maintenez ce fichier Ã  jour Ã  chaque bug critique rencontrÃ©*