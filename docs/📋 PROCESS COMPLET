# üìã PROCESS COMPLET - Ajouter une nouvelle section au formulaire

> **CONTEXTE** : Application React "Fiche logement" avec FormContext centralis√©, sauvegarde Supabase, 22 sections de formulaire. Architecture compl√®te fonctionnelle avec mapping FormContext ‚Üî Supabase.

---

## üéØ **√âTAPE 1 : PLANIFICATION DE LA NOUVELLE SECTION**

### ‚úÖ **1.1 - D√©finir la structure des donn√©es**
```javascript
// Exemple pour "section_exemple"
section_exemple: {
  champ_radio: null,               // Radio: true/false/null
  champ_radio_details: "",         // Input text conditionnel
  champ_textarea: "",              // Textarea
  champ_select: "",                // Select dropdown
  champ_checkbox: null,            // Checkbox: true/false/null
  photos_exemple: []               // Array de photos
}
```

### ‚úÖ **1.2 - Lister les colonnes Supabase n√©cessaires**
```sql
-- Pattern de nommage : {section}_{champ}
exemple_champ_radio BOOLEAN
exemple_champ_radio_details TEXT
exemple_champ_textarea TEXT
exemple_champ_select TEXT
exemple_champ_checkbox BOOLEAN
exemple_photos_exemple TEXT[]
```

**üìä Organisation table Supabase :**
- **Colonnes m√©tadonn√©es** : `id`, `user_id`, `nom`, `statut`, `created_at`, `updated_at`
- **Sections par ordre** : `proprietaire_*`, `logement_*`, `clefs_*`, `airbnb_*`, `booking_*`, `reglementation_*`, `exigences_*`, `avis_*`, `linge_*`, `equipements_*`, `consommables_*`, `visite_*`, `chambres_*`, `salle_de_bains_*`
- **Pattern coh√©rent** : `{section}_{champ}`
- **Types standards** : `TEXT`, `BOOLEAN`, `INTEGER`, `TEXT[]`

---

## üóÑÔ∏è **√âTAPE 2 : MISE √Ä JOUR SUPABASE**

### ‚úÖ **2.1 - Ex√©cuter le SQL d'ajout de colonnes**
```sql
-- Dans Supabase SQL Editor
ALTER TABLE fiches ADD COLUMN IF NOT EXISTS exemple_champ_radio BOOLEAN;
ALTER TABLE fiches ADD COLUMN IF NOT EXISTS exemple_champ_radio_details TEXT;
ALTER TABLE fiches ADD COLUMN IF NOT EXISTS exemple_champ_textarea TEXT;
ALTER TABLE fiches ADD COLUMN IF NOT EXISTS exemple_champ_select TEXT;
ALTER TABLE fiches ADD COLUMN IF NOT EXISTS exemple_champ_checkbox BOOLEAN;
ALTER TABLE fiches ADD COLUMN IF NOT EXISTS exemple_photos_exemple TEXT[];
```

### ‚úÖ **2.2 - V√©rification**
```sql
-- V√©rifier que les colonnes sont cr√©√©es
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'fiches' AND column_name LIKE 'exemple_%'
ORDER BY column_name;
```

---

## üèóÔ∏è **√âTAPE 3 : MISE √Ä JOUR FormContext.jsx**

### ‚úÖ **3.1 - Ajouter dans initialFormData**
```javascript
// Dans src/components/FormContext.jsx
// Remplacer section_exemple: {},
section_exemple: {
  champ_radio: null,
  champ_radio_details: "",
  champ_textarea: "",
  champ_select: "",
  champ_checkbox: null,
  photos_exemple: []
},
```

---

## üîÑ **√âTAPE 4 : MISE √Ä JOUR supabaseHelpers.js**

### ‚úÖ **4.1 - Ajouter dans mapFormDataToSupabase()**
```javascript
// Dans src/lib/supabaseHelpers.js
// Ajouter apr√®s la derni√®re section
exemple_champ_radio: formData.section_exemple?.champ_radio ?? null,
exemple_champ_radio_details: formData.section_exemple?.champ_radio_details || null,
exemple_champ_textarea: formData.section_exemple?.champ_textarea || null,
exemple_champ_select: formData.section_exemple?.champ_select || null,
exemple_champ_checkbox: formData.section_exemple?.champ_checkbox ?? null,
exemple_photos_exemple: formData.section_exemple?.photos_exemple || [],
```

### ‚úÖ **4.2 - Ajouter dans mapSupabaseToFormData()**
```javascript
// Dans src/lib/supabaseHelpers.js
// Ajouter apr√®s la derni√®re section
section_exemple: {
  champ_radio: supabaseData.exemple_champ_radio ?? null,
  champ_radio_details: supabaseData.exemple_champ_radio_details || "",
  champ_textarea: supabaseData.exemple_champ_textarea || "",
  champ_select: supabaseData.exemple_champ_select || "",
  champ_checkbox: supabaseData.exemple_champ_checkbox ?? null,
  photos_exemple: supabaseData.exemple_photos_exemple || []
},
```

---

## üìÑ **√âTAPE 5 : CR√âER LE COMPOSANT PAGE**

### ‚úÖ **5.1 - Template composant**
```javascript
// src/pages/FicheExemple.jsx
import React from 'react'
import { useForm } from '../components/FormContext'
import SidebarMenu from '../components/SidebarMenu'
import ProgressBar from '../components/ProgressBar'
import Button from '../components/Button'

export default function FicheExemple() {
  const { next, back, getField, updateField, handleSave, saveStatus } = useForm()

  // PATTERN IMPORTANT : R√©cup√©rer formData pour les bool√©ens
  const formData = getField('section_exemple')

  const handleInputChange = (field, value) => {
    updateField(field, value)
  }

  const handleRadioChange = (field, value) => {
    updateField(field, value === 'true' ? true : (value === 'false' ? false : null))
  }

  const handleCheckboxChange = (field, checked) => {
    updateField(field, checked ? true : null)
  }

  return (
    <div className="flex min-h-screen">
      <SidebarMenu />
      <div className="flex-1 flex flex-col">
        <ProgressBar />
        <div className="flex-1 p-6 bg-gray-100">
          <h1 className="text-2xl font-bold mb-6">Titre Section</h1>
          
          <div className="bg-white p-6 rounded-lg shadow space-y-6">
            
            {/* Exemple radio avec conditionnel */}
            <div>
              <label className="block font-semibold mb-3">Question radio</label>
              <div className="flex gap-4">
                <label className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    checked={formData.champ_radio === true}
                    onChange={() => handleRadioChange('section_exemple.champ_radio', 'true')}
                    className="w-4 h-4"
                  />
                  <span>Oui</span>
                </label>
                <label className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    checked={formData.champ_radio === false}
                    onChange={() => handleRadioChange('section_exemple.champ_radio', 'false')}
                    className="w-4 h-4"
                  />
                  <span>Non</span>
                </label>
              </div>
              
              {/* Affichage conditionnel */}
              {formData.champ_radio === true && (
                <div className="mt-3">
                  <input
                    type="text"
                    placeholder="D√©tails..."
                    value={formData.champ_radio_details || ""}
                    onChange={(e) => handleInputChange('section_exemple.champ_radio_details', e.target.value)}
                    className="w-full p-2 border rounded"
                  />
                </div>
              )}
            </div>

            {/* Messages sauvegarde */}
            {saveStatus.saving && <div className="text-blue-600">‚è≥ Sauvegarde...</div>}
            {saveStatus.saved && <div className="text-green-600">‚úÖ Sauvegard√© !</div>}
            {saveStatus.error && <div className="text-red-600">‚ùå {saveStatus.error}</div>}

            {/* Boutons navigation */}
            <div className="flex justify-between items-center pt-6 border-t">
              <Button variant="ghost" onClick={back}>Retour</Button>
              <div className="flex gap-2">
                <Button variant="secondary" onClick={handleSave}>Enregistrer</Button>
                <Button variant="primary" onClick={next}>Suivant</Button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}
```

---

## üéØ **√âTAPE 6 : INT√âGRATION DANS LE WIZARD**

### ‚úÖ **6.1 - Ajouter dans FicheWizard.jsx**
```javascript
// Dans src/pages/FicheWizard.jsx
import FicheExemple from './FicheExemple'

// Dans le tableau steps, remplacer le PlaceholderSection par :
<FicheExemple key="exemple" />,
```

---

## üß™ **√âTAPE 7 : TESTS ET VALIDATION**

### ‚úÖ **Tests obligatoires**
1. **Navigation** : Aller √† la nouvelle section
2. **Saisie** : Remplir les champs (radio + conditionnel)
3. **Sauvegarde** : Cliquer "Enregistrer" ‚Üí Message succ√®s
4. **Persistence** : Recharger la page ‚Üí Donn√©es pr√©sentes
5. **Navigation** : Changer de section et revenir ‚Üí Donn√©es conserv√©es

### ‚úÖ **V√©rification BDD**
```sql
-- V√©rifier les donn√©es sauvegard√©es
SELECT exemple_* FROM fiches WHERE id = 'ID_FICHE';
```

---

## üö® **PATTERNS CRITIQUES √Ä RESPECTER**

### ‚úÖ **Radio Buttons avec Bool√©ens**
```javascript
// ‚úÖ CORRECT - R√©cup√©rer formData puis propri√©t√©
const formData = getField('section_exemple')
const radioValue = formData.champ_radio  // true/false/null

// ‚ùå MAUVAIS - getField direct sur bool√©en
const radioValue = getField('section_exemple.champ_radio')
```

### ‚úÖ **Affichage Conditionnel**
```javascript
// Pattern obligatoire pour conditions
{radioValue === true && (
  <div>Champs conditionnels</div>
)}
```

### ‚úÖ **Mapping Supabase**
```javascript
// Bool√©ens : utiliser ?? null (permet true/false/null)
exemple_boolean: formData.section_exemple?.boolean_field ?? null,

// Textes : utiliser || null (√©vite cha√Ænes vides)
exemple_text: formData.section_exemple?.text_field || null,

// Arrays : utiliser || [] (valeur par d√©faut)
exemple_array: formData.section_exemple?.array_field || [],
```

---

## üìã **CHECKLIST FINALE**

- [ ] Colonnes Supabase ajout√©es et v√©rifi√©es
- [ ] `initialFormData` mis √† jour dans FormContext
- [ ] `mapFormDataToSupabase()` √©tendu
- [ ] `mapSupabaseToFormData()` √©tendu  
- [ ] Composant page cr√©√© avec patterns corrects
- [ ] Import ajout√© dans FicheWizard
- [ ] Test sauvegarde ‚úÖ
- [ ] Test chargement ‚úÖ
- [ ] Test navigation ‚úÖ
- [ ] Test affichage conditionnel ‚úÖ

---

## üéØ **BONNES PRATIQUES**

1. **Pattern de nommage coh√©rent** : `{section}_{champ}`
2. **Types Supabase standards** : `BOOLEAN`, `TEXT`, `INTEGER`, `TEXT[]`
3. **Mapping bool√©ens** : Toujours `?? null` pour pr√©server true/false/null
4. **Structure composant** : M√™me layout que les sections existantes
5. **Tests imm√©diat** : Valider apr√®s chaque √©tape
6. **Organisation BDD** : Respecter l'ordre des sections existantes

**Ce process garantit une int√©gration parfaite sans casser l'existant !** ‚úÖ