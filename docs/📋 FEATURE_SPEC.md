# üìã FEATURE_SPEC.md - Fiche Logement Letahost
*Sp√©cifications fonctionnelles - √âtat actuel : 18 Juin 2025*

---

## üéØ **VISION PRODUIT**

Application web mobile-first rempla√ßant les formulaires Jotform pour la cr√©ation de fiches logement Letahost. Interface moderne, navigation fluide, sauvegarde Supabase et **pr√©-population automatique Monday.com** pour optimiser le workflow terrain des coordinateurs.

---

## üë• **USER STORIES IMPL√âMENT√âES**

### ‚úÖ **Coordinateur Terrain**
- **Navigation fluide** : Je peux remplir une fiche √©tape par √©tape (22 sections) avec navigation libre
- **Persistance intelligente** : Je peux sauvegarder ma progression et revenir plus tard
- **Dashboard centralis√©** : Je vois toutes mes fiches avec filtres et recherche
- **Modification facile** : Je peux rouvrir et modifier une fiche existante √† tout moment
- **Nommage automatique** : Les noms de fiches se g√©n√®rent selon mes donn√©es (type + ville)
- **Contr√¥le utilisateur** : Je peux personnaliser le nom si je veux
- **Gestion erreurs** : Je peux supprimer mes fiches d'erreur facilement
- **Affichage conditionnel** : L'interface s'adapte selon mes r√©ponses (radio buttons)
- **üéØ PR√â-POPULATION MONDAY** : Je peux cliquer sur un lien Monday et avoir mes champs pr√©-remplis automatiquement

---

## ‚úÖ **FEATURES CORE IMPL√âMENT√âES**

### üèóÔ∏è **Architecture & State Management**

#### **FormContext - Cerveau de l'application**
```javascript
// State centralis√© avec logiques complexes
const FormContext = {
  // Navigation
  currentStep: 0-21,          // √âtape courante du wizard
  sections: [...],            // Liste des 22 sections
  next(), back(), goTo()      // Navigation programmable
  
  // Data management
  formData: initialFormData,  // Structure compl√®te 22 sections
  updateField(),              // Mise √† jour granulaire avec dot notation
  updateSection(),            // Mise √† jour section compl√®te
  getField(), getSection()    // Lecture s√©curis√©e (jamais undefined)
  
  // Persistance
  handleSave(),               // Sauvegarde Supabase avec feedback
  handleLoad(),               // Chargement fiche existante
  saveStatus: {...}           // √âtats UI (saving, saved, error)
  
  // Smart naming (innovation cl√©)
  generateFicheName(),        // Auto-g√©n√©ration intelligente
  hasManuallyNamedFiche       // Flag protection choix utilisateur
  
  // üéØ NOUVEAU - Pr√©-population Monday
  parseMondayParams(),        // Parse query params Monday
  applyMondayData(),          // Applique donn√©es Monday au formData
  hasMondayParams()           // D√©tecte pr√©sence params Monday
}
```

#### **Architecture des donn√©es √âTENDUE**
```javascript
// Structure unifi√©e FormContext ‚Üî Supabase ‚Üî Monday
const formData = {
  // M√©tadonn√©es fiche
  id, user_id, nom, statut, created_at, updated_at,
  
  // 22 sections mapp√©es
  section_proprietaire: { 
    prenom, nom, email, 
    adresse: { rue, complement, ville, codePostal }
  },
  section_logement: { 
    // üéØ NOUVEAUX champs Monday
    type_propriete: "",         // Dropdown principal (Appartement, Maison, etc.)
    surface: "",                // m¬≤ direct depuis Monday
    numero_bien: "",            // numeroDu depuis Monday
    typologie: "",              // T2, T3, T4, etc.
    nombre_personnes_max: "",   // nombreDe depuis Monday
    nombre_lits: "",            // lits depuis Monday (valeur brute)
    type_autre_precision: "",   // Si type = "Autre"
    
    // Structure appartement conditionnelle
    appartement: {
      nom_residence: "", batiment: "", acces: "", etage: "", numero_porte: ""
    }
  },
  section_clefs: { interphone, boiteType, ttlock: {...}, ... },
  section_airbnb: { annonce_active, url_annonce, ... },
  section_booking: { ... },
  // + 17 sections avec structure extensible (√† venir)
}
```

### üéØ **PR√â-POPULATION MONDAY - FEATURE PRINCIPALE**

#### **Workflow Monday ‚Üí Application**
```javascript
// 1. URL Monday g√©n√©r√©e
https://app.business-immobilier.fr/fiche-logement/create.php?
fullName=Florence TEISSIER&nom=Florence TEISSIER&email=floteissier649@gmail.com&
adresse[addr_line1]=660 Lara&adresse[city]=Saint Pons&adresse[postal]=05000&
numeroDu=1163&nombreDe=2&m2=28&lits=1 lit double

// 2. Mapping automatique Monday ‚Üí FormContext
fullName/nom ‚Üí section_proprietaire.nom
email ‚Üí section_proprietaire.email  
adresse[addr_line1] ‚Üí section_proprietaire.adresse.rue
adresse[city] ‚Üí section_proprietaire.adresse.ville
adresse[postal] ‚Üí section_proprietaire.adresse.codePostal
numeroDu ‚Üí section_logement.numero_bien
nombreDe ‚Üí section_logement.nombre_personnes_max
m2 ‚Üí section_logement.surface
lits ‚Üí section_logement.nombre_lits (valeur brute pr√©serv√©e)
```

#### **Authentication Flow avec localStorage**
```javascript
// Si utilisateur pas connect√© + params Monday d√©tect√©s :
1. localStorage.setItem('pendingMondayParams', location.search)
2. navigate('/login') + message "üìã Formulaire Monday en attente"
3. Apr√®s connexion r√©ussie ‚Üí r√©cup√©ration params + redirection /fiche
4. Application donn√©es + nettoyage localStorage
5. Smart naming automatique selon donn√©es pr√©-remplies
```

#### **Architecture App.jsx optimis√©e**
```javascript
// FormProvider englobe TOUTE l'application
<AuthProvider>
  <FormProvider> {/* FormContext disponible partout, y compris /login */}
    <Routes>
      <Route path="/login" element={<Login />} />
      <Route path="/fiche" element={<ProtectedRoute><FicheWizard /></ProtectedRoute>} />
    </Routes>
  </FormProvider>
</AuthProvider>
```

### üß≠ **Navigation & UX**

#### **Navigation unifi√©e**
```javascript
// Syst√®me centralis√© dans FormContext
const navigation = {
  currentStep: 0-21,                    // Index section courante
  next(): setCurrentStep(step + 1),     // Avancer
  back(): setCurrentStep(step - 1),     // Reculer  
  goTo(index): setCurrentStep(index)    // Aller √† section directe
}

// Synchronisation sidebar ‚Üî boutons
// M√™me source de v√©rit√© partout
```

#### **Barre de progression intelligente**
- **22 points** repr√©sentant chaque section
- **Pourcentage completion** calcul√© dynamiquement
- **√âtats visuels** : compl√©t√© (dor√©), actuel (cercl√©), √† venir (gris)
- **Tooltips** avec noms des sections
- **Responsive** : adaptation mobile automatique

#### **Chargement automatique URL**
```javascript
// Dans FormContext useEffect - PRIORIT√âS R√âORGANIS√âES
1. Traiter params Monday en attente (localStorage) SI connect√©
2. Redirection login si params Monday + pas connect√©  
3. Application directe si connect√© + params Monday
4. Chargement fiche existante par ID
5. Reset pour nouvelle fiche vide
```

### üß† **Smart Naming System**

#### **Logique auto-g√©n√©ration √âTENDUE**
```javascript
const generateFicheName = (data) => {
  // Priorit√© aux nouveaux champs Monday
  const type = data.section_logement?.type_propriete || data.section_logement?.type
  const ville = data.section_proprietaire?.adresse?.ville || data.section_logement?.adresse?.ville
  
  // Capitalisation automatique
  const capitalize = (str) => str.charAt(0).toUpperCase() + str.slice(1).toLowerCase()
  
  // Logique prioritaire
  if (type && ville) return `${capitalize(type)} ${capitalize(ville)}` // "Appartement Paris"
  else if (ville) return `Logement ${capitalize(ville)}`               // "Logement Paris"  
  else if (type) return `${capitalize(type)}`                          // "Appartement"
  return "Nouvelle fiche"                                              // Fallback
}

// Protection modification manuelle
const hasManuallyNamedFiche = useState(false) // Flag protection
```

#### **Row Level Security (RLS)**
- Chaque user voit **uniquement ses fiches** (isolation par user_id)
- Requ√™tes automatiquement filtr√©es par Supabase
- Pas de gestion c√¥t√© client (s√©curit√© serveur)

---

## üé® **INTERFACE & DESIGN**

### **Mobile-First Responsive**
- **Breakpoints** : Mobile ‚Üí Tablet ‚Üí Desktop
- **Navigation** : Sidebar collapsible, boutons tactiles optimis√©s
- **Grilles** : 1 ‚Üí 2 ‚Üí 3 colonnes selon √©cran
- **Typography** : Hi√©rarchie claire, contraste optimis√©

### **Feedback Utilisateur**
- **√âtats loading** : Spinners + messages explicites
- **Messages succ√®s/erreur** : Couleurs, ic√¥nes, auto-disparition
- **Confirmations** : Modals pour actions destructives
- **Placeholders** : Textes informatifs et guidants
- **üéØ Message Monday** : Alerte bleue "Formulaire Monday en attente" sur page login

### **Affichage Conditionnel**
```javascript
// Pattern pour champs selon r√©ponses radio
const formData = getField('section_clefs')  // Pour bool√©ens
const interphone = formData.interphone      // true/false/null

{interphone === true && (
  <div>
    <input placeholder="D√©tails interphone..." />
  </div>
)}

// Pattern pour sections complexes (Appartement)
const typePropriete = getField('section_logement.type_propriete')
{typePropriete === 'Appartement' && (
  <div>Section acc√®s appartement compl√®te</div>
)}
```

---

## üì± **SECTIONS FORMULAIRE IMPL√âMENT√âES (5/22)**

### **‚úÖ Section Propri√©taire (FicheForm.jsx)**
- **Champ nom fiche** : Visible, modifiable, avec smart naming
- **Identit√©** : Pr√©nom, nom, email avec validation
- **Adresse compl√®te** : Rue, compl√©ment, ville, code postal
- **üéØ Pr√©-population Monday** : Nom, email, adresse auto-remplis
- **Integration** : getField/updateField pour tous les champs

### **‚úÖ Section Logement (FicheLogement.jsx) - RESTRUCTUR√âE**  
- **Type propri√©t√©** : Dropdown (Appartement, Maison, Villa, Studio, Loft, Autre)
- **üéØ Champs Monday** : Surface m¬≤, num√©ro bien, typologie, personnes max, nombre lits
- **Autre sp√©cialis√©** : Dropdown 40+ options (Ch√¢teaux, Yourtes, Tipis, etc.)
- **Section Appartement** : Conditionnelle (nom r√©sidence, b√¢timent, acc√®s RDC/Escalier/Ascenseur, √©tage, num√©ro porte)
- **üéØ Pr√©-population Monday** : Tous champs logement auto-remplis
- **Smart naming** : Type + ville ‚Üí g√©n√©ration automatique nom

### **‚úÖ Section Clefs (FicheClefs.jsx)**
- **Interphone** : Radio Oui/Non + d√©tails conditionnels
- **Tempo g√¢che** : Radio + d√©tails + photo
- **Digicode** : Radio + d√©tails + photo  
- **Types bo√Ætes** : TTlock, Igloohome, Masterlock
- **Champs sp√©cialis√©s** : Codes sp√©cifiques par type de bo√Æte
- **Affichage conditionnel** : Interface adaptative selon r√©ponses

### **‚úÖ Section Airbnb (FicheAirbnb.jsx)**
- **Annonce active** : Radio Oui/Non
- **URL annonce** : Conditionnelle si active
- **Identifiants** : Radio obtenus/non + champs email/password
- **Guide pr√©paration** : Checkboxes vid√©o/photos
- **Explication refus** : Textarea si pas d'identifiants

### **‚úÖ Section Booking (FicheBooking.jsx)**
- **Structure identique** : M√™me logique qu'Airbnb
- **Champs parall√®les** : URL, identifiants, explication
- **Affichage conditionnel** : M√™me patterns

---

## üß™ **PATTERNS DE D√âVELOPPEMENT √âTABLIS**

### **Cr√©ation nouvelle section (Template)**
```javascript
// 1. Copier FicheForm.jsx ‚Üí FicheNouvelle.jsx
// 2. Adapter les imports et le titre
// 3. Utiliser le pattern obligatoire :

const { getField, updateField, handleSave, saveStatus } = useForm()

// 4. Pour champs simples :
<input 
  value={getField('section_nouvelle.champ')}
  onChange={(e) => updateField('section_nouvelle.champ', e.target.value)}
/>

// 5. Pour radio buttons (ATTENTION bool√©ens) :
const formData = getField('section_nouvelle')  // Pas getField direct!
const radioValue = formData.radio_field        // true/false/null

<input 
  type="radio" 
  checked={radioValue === true}
  onChange={() => updateField('section_nouvelle.radio_field', true)}
/>

// 6. Affichage conditionnel :
{radioValue === true && (
  <div>Champs conditionnels</div>
)}

// 7. Ajouter dans FicheWizard.jsx steps[]
```

### **Structure obligatoire composant section**
```javascript
<div className="flex min-h-screen">
  <SidebarMenu />
  <div className="flex-1 flex flex-col">
    <ProgressBar />
    <div className="flex-1 p-6 bg-gray-100">
      <h1 className="text-2xl font-bold mb-6">Titre Section</h1>
      
      {/* Champs formulaire */}
      
      {/* Messages sauvegarde */}
      {saveStatus.saving && <div>‚è≥ Sauvegarde...</div>}
      {saveStatus.saved && <div>‚úÖ Sauvegard√© !</div>}
      {saveStatus.error && <div>‚ùå {saveStatus.error}</div>}
      
      {/* Boutons navigation coh√©rents */}
      <div className="mt-6 flex justify-between">
        <Button variant="ghost" onClick={back}>Retour</Button>
        <div className="flex gap-3">
          <Button variant="secondary" onClick={handleSave}>Enregistrer</Button>
          <Button variant="primary" onClick={next}>Suivant</Button>
        </div>
      </div>
    </div>
  </div>
</div>
```

---

## ‚ö° **LOGIQUES CRITIQUES - √Ä NE JAMAIS CASSER**

### **üî• Smart Naming - S√©quence exacte**
```javascript
// 1. User tape type "appartement" ‚Üí updateField d√©clench√©
// 2. hasManuallyNamedFiche v√©rifi√© (false = auto-gen autoris√©e)
// 3. generateFicheName() appel√©e avec nouvelles donn√©es
// 4. Conditions v√©rifi√©es (nom actuel = "Nouvelle fiche" ou ancien auto-g√©n√©r√©)
// 5. Nouveau nom appliqu√© avec capitalisation
// 6. Si user modifie nom direct ‚Üí hasManuallyNamedFiche = true (protection)
```

### **üî• Pr√©-population Monday - Flow critique**
```javascript
// Variables cl√©s dans FormContext useEffect :
- mondayParamsPresentInURL     // D√©tection params dans URL
- pendingMondayParamsInStorage // Params sauv√©s localStorage
- authLoading, user            // √âtat authentification

// S√©quence PRIORIT√âS (ordre crucial) :
1. SI connect√© + localStorage params ‚Üí Application imm√©diate + nettoyage
2. SI params URL + pas connect√© ‚Üí Sauvegarde localStorage + redirect login  
3. SI connect√© + params URL ‚Üí Application directe
4. Chargement fiche existante par ID
5. Reset pour nouvelle fiche vide
```

### **üî• useEffect optimis√© - √âviter boucles infinies**
```javascript
// D√©pendances LIMIT√âES pour √©viter 80k+ messages console :
useEffect(() => {
  // Logique pr√©-population Monday...
}, [
  location.search,  // Changement URL
  authLoading,      // √âtat auth
  user,             // User connect√©
  navigate          // Navigation
  // üö® PAS formData.id, saveStatus, fonctions internes = boucle !
])
```

### **üî• Navigation URL - Gestion √©tats**
```javascript
// Variables cl√©s dans FormContext useEffect :
- ficheId          // ID depuis URL (?id=123)
- authLoading      // Attendre auth avant chargement
- initialLoadComplete // √âviter boucles infinies

// S√©quence chargement :
1. useEffect d√©tecte ficheId dans URL
2. Attente authLoading = false (user disponible)
3. handleLoad(ficheId) appel√© UNE FOIS
4. Success ‚Üí formData mis √† jour + hasManuallyNamedFiche d√©fini
5. initialLoadComplete = true (stop boucle)
```

---

## üß™ **TESTS VALID√âS & SC√âNARIOS**

### **‚úÖ Pr√©-population Monday - VALID√â 100%**
1. **URL Monday (d√©connect√©)** ‚Üí Redirection /login + message bleu ‚úì
2. **Connexion** ‚Üí Retour /fiche avec champs pr√©-remplis ‚úì
3. **Smart naming** ‚Üí "Logement Paris" g√©n√©r√© automatiquement ‚úì
4. **Tous champs Monday** ‚Üí Nom, email, ville, num√©ro bien, surface, lits ‚úì
5. **URL Monday (connect√©)** ‚Üí Application directe sans login ‚úì
6. **Nettoyage localStorage** ‚Üí Pas de pollution entre sessions ‚úì

### **‚úÖ Smart Naming complet**
1. **Nouvelle fiche** ‚Üí "Nouvelle fiche" affich√© ‚úì
2. **Type "Studio" + ville "Lyon"** ‚Üí "Studio Lyon" g√©n√©r√© ‚úì
3. **Modification manuelle** ‚Üí "Mon Appart Personnel" prot√©g√© ‚úì
4. **Modification logement apr√®s manual** ‚Üí Nom reste prot√©g√© ‚úì
5. **Reset nom √† "Nouvelle fiche"** ‚Üí Auto-g√©n√©ration reprend ‚úì
6. **Capitalisation** ‚Üí "Appartement Paris" pas "appartement paris" ‚úì

### **‚úÖ Workflow complet Dashboard ‚Üî Formulaire**
1. **Dashboard ‚Üí Nouvelle fiche** ‚Üí Formulaire vide ‚úì
2. **Remplissage + sauvegarde** ‚Üí Retour Dashboard ‚Üí Fiche list√©e ‚úì
3. **Dashboard ‚Üí Modifier fiche** ‚Üí Donn√©es pr√©-remplies ‚úì
4. **Modification + sauvegarde** ‚Üí Timestamp updated_at mis √† jour ‚úì
5. **Navigation sections** ‚Üí Donn√©es persistantes entre pages ‚úì

### **‚úÖ Suppression & gestion erreurs**
1. **Clic poubelle** ‚Üí Modal confirmation ‚úì
2. **Confirmer** ‚Üí Fiche dispara√Æt imm√©diatement + BDD ‚úì
3. **Annuler** ‚Üí Modal ferme, rien ne change ‚úì
4. **Filtres Dashboard** ‚Üí Compteurs mis √† jour automatiquement ‚úì

### **‚úÖ Affichage conditionnel (FicheClefs)**
1. **Interphone = Non** ‚Üí Champs d√©tails cach√©s ‚úì
2. **Interphone = Oui** ‚Üí Champs d√©tails visibles ‚úì
3. **Type bo√Æte TTlock** ‚Üí Champs TTlock visibles uniquement ‚úì
4. **Sauvegarde bool√©ens** ‚Üí Values true/false/null correctes en base ‚úì

### **‚úÖ Section Logement - Affichage conditionnel**
1. **Type = "Autre"** ‚Üí Dropdown 40+ options visible ‚úì
2. **Type = "Appartement"** ‚Üí Section acc√®s appartement visible ‚úì
3. **Acc√®s = "RDC/Escalier/Ascenseur"** ‚Üí Options correctes ‚úì
4. **Tous champs requis** ‚Üí Labels + placeholders informatifs ‚úì

---

## üöÄ **ENVIRONNEMENTS & D√âPLOIEMENT**

### **Production**
- **URL :** https://fiche-logement-ia-githubcopilot-v1.vercel.app/
- **Auto-deploy :** Push `main` ‚Üí Vercel
- **Database :** Supabase Production (RLS activ√©)
- **Performance :** Mobile 3G < 2s loading

### **D√©veloppement**  
- **Local :** `npm run dev` (Vite hot reload)
- **Database :** M√™me instance Supabase (isolation par user_id)
- **Debug :** Console logs + debug panels disponibles

---

## üìä **M√âTRIQUES DE SUCC√àS ACTUELLES**

### **‚úÖ Performance valid√©e**
- ‚è±Ô∏è **Chargement Dashboard** < 1s
- üíæ **Sauvegarde fiche** < 500ms  
- üì± **Score mobile Lighthouse** > 85
- üîÑ **Navigation sections** instantan√©e
- üéØ **Pr√©-population Monday** < 2s (redirection + application)

### **‚úÖ UX valid√©e**
- üß≠ **Navigation intuitive** (sidebar + boutons synchronis√©s)
- üí° **Smart naming appr√©ci√©** (plus de "Nouvelle fiche" partout)
- üóëÔ∏è **Suppression s√©curis√©e** (z√©ro suppression accidentelle en test)
- üìä **Dashboard lisible** (statuts, dates, recherche efficace)
- üéØ **Monday workflow** (coordinateurs adoptent sans formation)

---

## ‚ö†Ô∏è **LIMITATIONS CONNUES**

### **Techniques**
- **Pas d'offline** : Connexion internet requise
- **RLS strict** : Pas de partage fiches entre users (volontaire)
- **Sauvegarde manuelle** : Pas d'auto-save (choix UX)
- **useEffect sensible** : D√©pendances limit√©es pour √©viter boucles

### **Fonctionnelles**
- **17 sections manquantes** : Pattern √©tabli pour ajout
- **Pas d'upload photos** : Google Drive API √† int√©grer
- **Pas de PDF g√©n√©ration** : Make.com + GPT √† connecter
- **Schema Supabase √† adapter** : Nouveaux champs Monday √† ajouter

---

## üéØ **MILESTONE CRITIQUE ATTEINT**

### **‚úÖ REMPLACEMENT JOTFORM VALID√â**
- **Workflow Monday ‚Üí Auth ‚Üí Pr√©-population** = 100% op√©rationnel
- **Interface moderne** vs formulaires Jotform obsol√®tes
- **Navigation fluide** 22 sections vs pages Jotform lentes
- **Smart naming** vs noms g√©n√©riques Jotform
- **Dashboard centralis√©** vs dispersion Jotform

### **üöÄ Impact Business**
- **Coordinateurs terrain** peuvent utiliser liens Monday existants
- **Aucune rupture** dans workflow Monday.com
- **Gain productivit√©** : formulaires pr√©-remplis automatiquement
- **UX moderne** : mobile-first, responsive, intuitive

---

## üìã **PROCHAINES √âTAPES IDENTIFI√âES**

### **üö® URGENT - Schema Supabase**
- üî≤ **Adapter table `fiches`** pour nouveaux champs Monday
- üî≤ **Colonnes √† ajouter :** 
  ```sql
  ALTER TABLE fiches ADD COLUMN logement_numero_bien VARCHAR(50);
  ALTER TABLE fiches ADD COLUMN logement_surface INTEGER;
  ALTER TABLE fiches ADD COLUMN logement_nombre_personnes_max VARCHAR(20);
  ALTER TABLE fiches ADD COLUMN logement_nombre_lits TEXT;
  ALTER TABLE fiches ADD COLUMN logement_type_propriete VARCHAR(50);
  ALTER TABLE fiches ADD COLUMN logement_typologie VARCHAR(10);
  ```

### **Sprint suivant**
- üî≤ **17 sections manquantes** (pattern √©tabli, reproductible facilement)
- üî≤ **Upload photos Google Drive** (architecture d√©finie)  
- üî≤ **G√©n√©ration PDF + GPT** via Make.com
- üî≤ **Sync Monday bidirectionnelle** (optionnel)

---

*Derni√®re mise √† jour : 18 Juin 2025 - Session Pr√©-population Monday*  
*Architecture valid√©e, pr√™te pour remplacement Jotform en production* üöÄ