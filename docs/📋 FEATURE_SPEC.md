# üìã FEATURE_SPEC.md - Fiche Logement Letahost
*Sp√©cifications fonctionnelles - √âtat actuel : Juin 2025*

---

## üéØ **VISION PRODUIT**

Application web mobile-first rempla√ßant les formulaires Jotform pour la cr√©ation de fiches logement Letahost. Interface moderne, navigation fluide, sauvegarde Supabase et intelligence automatique pour optimiser le workflow terrain des coordinateurs.

---

## üë• **USER STORIES IMPL√âMENT√âES**

### ‚úÖ **Coordinateur Terrain**
- **Navigation fluide** : Je peux remplir une fiche √©tape par √©tape (22 sections) avec navigation libre
- **Persistance intelligente** : Je peux sauvegarder ma progression et revenir plus tard
- **Dashboard centralis√©** : Je vois toutes mes fiches avec filtres et recherche
- **Modification facile** : Je peux rouvrir et modifier une fiche existante √† tout moment
- **Nommage automatique** : Les noms de fiches se g√©n√®rent selon mes donn√©es (type + ville)
- **Contr√¥le utilisateur** : Je peux personnaliser le nom si je veux
- **Gestion erreurs** : Je peux supprimer mes fiches d'erreur facilement
- **Affichage conditionnel** : L'interface s'adapte selon mes r√©ponses (radio buttons)

---

## ‚úÖ **FEATURES CORE IMPL√âMENT√âES**

### üèóÔ∏è **Architecture & State Management**

#### **FormContext - Cerveau de l'application**
```javascript
// State centralis√© avec logiques complexes
const FormContext = {
  // Navigation
  currentStep: 0-21,          // √âtape courante du wizard
  sections: [...],            // Liste des 22 sections
  next(), back(), goTo()      // Navigation programmable
  
  // Data management
  formData: initialFormData,  // Structure compl√®te 22 sections
  updateField(),              // Mise √† jour granulaire avec dot notation
  updateSection(),            // Mise √† jour section compl√®te
  getField(), getSection()    // Lecture s√©curis√©e (jamais undefined)
  
  // Persistance
  handleSave(),               // Sauvegarde Supabase avec feedback
  handleLoad(),               // Chargement fiche existante
  saveStatus: {...}           // √âtats UI (saving, saved, error)
  
  // Smart naming (innovation cl√©)
  generateFicheName(),        // Auto-g√©n√©ration intelligente
  hasManuallyNamedFiche       // Flag protection choix utilisateur
}
```

#### **Architecture des donn√©es**
```javascript
// Structure unifi√©e FormContext ‚Üî Supabase
const formData = {
  // M√©tadonn√©es fiche
  id, user_id, nom, statut, created_at, updated_at,
  
  // 22 sections mapp√©es
  section_proprietaire: { prenom, nom, email, adresse: {...} },
  section_logement: { type, adresse: {...}, caracteristiques: {...} },
  section_clefs: { interphone, boiteType, ttlock: {...}, ... },
  section_airbnb: { annonce_active, url_annonce, ... },
  section_booking: { ... },
  // + 17 sections avec structure extensible (√† venir)
}
```

### üß† **Smart Naming System**

#### **Logique auto-g√©n√©ration**
```javascript
const generateFicheName = (currentData) => {
  const type = currentData.section_logement?.type          // "appartement"
  const ville = currentData.section_logement?.adresse?.ville // "paris"
  
  // Capitalisation automatique
  const capitalize = (str) => str.charAt(0).toUpperCase() + str.slice(1).toLowerCase()
  
  // Logique prioritaire
  if (type && ville) return `${capitalize(type)} ${capitalize(ville)}` // "Appartement Paris"
  else if (ville) return `Logement ${capitalize(ville)}`               // "Logement Paris"  
  else if (type) return `${capitalize(type)}`                          // "Appartement"
  return "Nouvelle fiche"                                              // Fallback
}
```

#### **Protection choix utilisateur**
```javascript
// Dans updateField() - Logique critique
if (fieldPath === 'nom') {
  // User modifie nom directement ‚Üí mode manuel
  setHasManuallyNamedFiche(value !== "Nouvelle fiche")
} else if (!hasManuallyNamedFiche) {
  // User n'a pas pris contr√¥le ‚Üí auto-g√©n√©ration autoris√©e
  const newName = generateFicheName(newData)
  if (shouldUpdateName(currentName, newName)) {
    newData.nom = newName
  }
}
```

### üìä **Dashboard & Gestion Fiches**

#### **Hook useFiches - Interface Dashboard**
```javascript
export const useFiches = () => {
  const [fiches, setFiches] = useState([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState(null)
  
  // CRUD operations
  const fetchFiches = async () => {
    const result = await getUserFiches(user.id)
    // Gestion states + erreurs
  }
  
  const handleDeleteFiche = async (ficheId) => {
    // Suppression optimiste : UI puis base
    setFiches(prev => prev.filter(f => f.id !== ficheId))
    await deleteFiche(ficheId)
  }
  
  return { fiches, loading, error, refetch, deleteFiche: handleDeleteFiche }
}
```

#### **Features Dashboard**
- **Filtres dynamiques** : "Tous", "Brouillon", "Compl√©t√©", "Archiv√©" avec compteurs
- **Recherche temps r√©el** : Par nom de fiche, mise √† jour instantan√©e
- **Suppression s√©curis√©e** : Modal confirmation + suppression optimiste
- **Navigation intelligente** : 
  - `navigate('/fiche')` ‚Üí Nouvelle fiche
  - `navigate(`/fiche?id=${fiche.id}`)` ‚Üí Modification fiche existante

### üíæ **Persistance & Supabase Integration**

#### **Mapping bidirectionnel**
```javascript
// FormContext ‚Üí Supabase (mapFormDataToSupabase)
{
  nom: formData.nom,
  proprietaire_prenom: formData.section_proprietaire?.prenom,
  logement_type: formData.section_logement?.type,
  // ... mapping complet vers colonnes plates
}

// Supabase ‚Üí FormContext (mapSupabaseToFormData)  
{
  section_proprietaire: {
    prenom: supabaseData.proprietaire_prenom || "",
    // ... reconstruction structure imbriqu√©e
  }
}
```

#### **CRUD Helpers format uniforme**
```javascript
// Pattern obligatoire pour tous les helpers
return {
  success: true/false,
  data: ...,           // Si success
  error: "...",        // Si √©chec
  message: "..."       // Feedback utilisateur
}

// Exemples impl√©ment√©s
- saveFiche(formData, userId)     // CREATE/UPDATE avec d√©tection automatique
- loadFiche(ficheId)              // READ avec mapping automatique  
- getUserFiches(userId)           // LIST avec tri par updated_at
- deleteFiche(ficheId)            // DELETE simple
```

### üîê **Authentification & S√©curit√©**

#### **AuthContext Supabase**
```javascript
// Gestion auth centralis√©e
const useAuth = () => ({
  user,                    // Objet user Supabase ou null
  loading,                 // √âtat chargement session
  signIn(email, password), // Connexion
  signOut(),               // D√©connexion
  isAuthenticated: !!user  // Helper boolean
})

// Protection routes
<ProtectedRoute>
  <FormProvider>
    <FicheWizard />
  </FormProvider>
</ProtectedRoute>
```

#### **Row Level Security (RLS)**
- Chaque user voit **uniquement ses fiches** (isolation par user_id)
- Requ√™tes automatiquement filtr√©es par Supabase
- Pas de gestion c√¥t√© client (s√©curit√© serveur)

### üß≠ **Navigation & UX**

#### **Navigation unifi√©e**
```javascript
// Syst√®me centralis√© dans FormContext
const navigation = {
  currentStep: 0-21,                    // Index section courante
  next(): setCurrentStep(step + 1),     // Avancer
  back(): setCurrentStep(step - 1),     // Reculer  
  goTo(index): setCurrentStep(index)    // Aller √† section directe
}

// Synchronisation sidebar ‚Üî boutons
// M√™me source de v√©rit√© partout
```

#### **Barre de progression intelligente**
- **22 points** repr√©sentant chaque section
- **Pourcentage completion** calcul√© dynamiquement
- **√âtats visuels** : compl√©t√© (dor√©), actuel (cercl√©), √† venir (gris)
- **Tooltips** avec noms des sections
- **Responsive** : adaptation mobile automatique

#### **Chargement automatique URL**
```javascript
// Dans FormContext useEffect
const location = useLocation()
const queryParams = new URLSearchParams(location.search)
const ficheId = queryParams.get('id')

if (ficheId && !initialLoadComplete) {
  // Chargement automatique fiche existante
  const result = await handleLoad(ficheId)
  // + gestion hasManuallyNamedFiche selon nom charg√©
}
```

---

## üé® **INTERFACE & DESIGN**

### **Mobile-First Responsive**
- **Breakpoints** : Mobile ‚Üí Tablet ‚Üí Desktop
- **Navigation** : Sidebar collapsible, boutons tactiles optimis√©s
- **Grilles** : 1 ‚Üí 2 ‚Üí 3 colonnes selon √©cran
- **Typography** : Hi√©rarchie claire, contraste optimis√©

### **Feedback Utilisateur**
- **√âtats loading** : Spinners + messages explicites
- **Messages succ√®s/erreur** : Couleurs, ic√¥nes, auto-disparition
- **Confirmations** : Modals pour actions destructives
- **Placeholders** : Textes informatifs et guidants

### **Affichage Conditionnel**
```javascript
// Pattern pour champs selon r√©ponses radio
const formData = getField('section_clefs')  // Pour bool√©ens
const interphone = formData.interphone      // true/false/null

{interphone === true && (
  <div>
    <input placeholder="D√©tails interphone..." />
  </div>
)}
```

---

## üì± **SECTIONS FORMULAIRE IMPL√âMENT√âES (5/22)**

### **‚úÖ Section Propri√©taire (FicheForm.jsx)**
- **Champ nom fiche** : Visible, modifiable, avec smart naming
- **Identit√©** : Pr√©nom, nom, email avec validation
- **Adresse compl√®te** : Rue, compl√©ment, ville, code postal
- **Integration** : getField/updateField pour tous les champs

### **‚úÖ Section Logement (FicheLogement.jsx)**  
- **Type** : Select (Appartement, Maison, Studio, etc.)
- **Adresse logement** : Distincte de l'adresse propri√©taire
- **Caract√©ristiques** : Nombre pi√®ces, chambres, surface
- **Acc√®s** : Description textuelle
- **Smart naming** : Type + ville ‚Üí g√©n√©ration automatique nom

### **‚úÖ Section Clefs (FicheClefs.jsx)**
- **Interphone** : Radio Oui/Non + d√©tails conditionnels
- **Tempo g√¢che** : Radio + d√©tails + photo
- **Digicode** : Radio + d√©tails + photo  
- **Types bo√Ætes** : TTlock, Igloohome, Masterlock
- **Champs sp√©cialis√©s** : Codes sp√©cifiques par type de bo√Æte
- **Affichage conditionnel** : Interface adaptative selon r√©ponses

### **‚úÖ Section Airbnb (FicheAirbnb.jsx)**
- **Annonce active** : Radio Oui/Non
- **URL annonce** : Conditionnelle si active
- **Identifiants** : Radio obtenus/non + champs email/password
- **Guide pr√©paration** : Checkboxes vid√©o/photos
- **Explication refus** : Textarea si pas d'identifiants

### **‚úÖ Section Booking (FicheBooking.jsx)**
- **Structure identique** : M√™me logique qu'Airbnb
- **Champs parall√®les** : URL, identifiants, explication
- **Affichage conditionnel** : M√™me patterns

---

## üß™ **PATTERNS DE D√âVELOPPEMENT √âTABLIS**

### **Cr√©ation nouvelle section (Template)**
```javascript
// 1. Copier FicheForm.jsx ‚Üí FicheNouvelle.jsx
// 2. Adapter les imports et le titre
// 3. Utiliser le pattern obligatoire :

const { getField, updateField, handleSave, saveStatus } = useForm()

// 4. Pour champs simples :
<input 
  value={getField('section_nouvelle.champ')}
  onChange={(e) => updateField('section_nouvelle.champ', e.target.value)}
/>

// 5. Pour radio buttons (ATTENTION bool√©ens) :
const formData = getField('section_nouvelle')  // Pas getField direct!
const radioValue = formData.radio_field        // true/false/null

<input 
  type="radio" 
  checked={radioValue === true}
  onChange={() => updateField('section_nouvelle.radio_field', true)}
/>

// 6. Affichage conditionnel :
{radioValue === true && (
  <div>Champs conditionnels</div>
)}

// 7. Ajouter dans FicheWizard.jsx steps[]
```

### **Structure obligatoire composant section**
```javascript
<div className="flex min-h-screen">
  <SidebarMenu />
  <div className="flex-1 flex flex-col">
    <ProgressBar />
    <div className="flex-1 p-6 bg-gray-100">
      <h1 className="text-2xl font-bold mb-6">Titre Section</h1>
      
      {/* Champs formulaire */}
      
      {/* Messages sauvegarde */}
      {saveStatus.saving && <div>‚è≥ Sauvegarde...</div>}
      {saveStatus.saved && <div>‚úÖ Sauvegard√© !</div>}
      {saveStatus.error && <div>‚ùå {saveStatus.error}</div>}
      
      {/* Boutons navigation */}
      <div className="mt-6 flex justify-between">
        <Button variant="ghost" onClick={back}>Retour</Button>
        <div className="flex gap-3">
          <Button variant="secondary" onClick={handleSave}>Enregistrer</Button>
          <Button variant="primary" onClick={next}>Suivant</Button>
        </div>
      </div>
    </div>
  </div>
</div>
```

---

## ‚ö° **LOGIQUES CRITIQUES - √Ä NE JAMAIS CASSER**

### **üî• Smart Naming - S√©quence exacte**
```javascript
// 1. User tape type "appartement" ‚Üí updateField d√©clench√©
// 2. hasManuallyNamedFiche v√©rifi√© (false = auto-gen autoris√©e)
// 3. generateFicheName() appel√©e avec nouvelles donn√©es
// 4. Conditions v√©rifi√©es (nom actuel = "Nouvelle fiche" ou ancien auto-g√©n√©r√©)
// 5. Nouveau nom appliqu√© avec capitalisation
// 6. Si user modifie nom direct ‚Üí hasManuallyNamedFiche = true (protection)
```

### **üî• Navigation URL - Gestion √©tats**
```javascript
// Variables cl√©s dans FormContext useEffect :
- ficheId          // ID depuis URL (?id=123)
- authLoading      // Attendre auth avant chargement
- initialLoadComplete // √âviter boucles infinies

// S√©quence chargement :
1. useEffect d√©tecte ficheId dans URL
2. Attente authLoading = false (user disponible)
3. handleLoad(ficheId) appel√© UNE FOIS
4. Success ‚Üí formData mis √† jour + hasManuallyNamedFiche d√©fini
5. initialLoadComplete = true (stop boucle)
```

### **üî• Suppression optimiste - Ordre op√©rations**
```javascript
// CORRECT (UI r√©active) :
1. setFiches(prev => prev.filter(f => f.id !== ficheId))  // UI imm√©diate
2. await deleteFiche(ficheId)                             // Base apr√®s
3. Si erreur ‚Üí refetch() pour corriger UI

// INCORRECT (UI lente) :
1. await deleteFiche(ficheId)   // User attend...
2. refetch()                    // Encore attendre...
```

### **üî• FormContext updateField - Dot notation**
```javascript
// Gestion path complexes avec cr√©ation objets :
'section_proprietaire.adresse.rue' ‚Üí 
{
  section_proprietaire: {
    adresse: {
      rue: "valeur"
    }
  }
}

// Protection undefined + spread operators pour immutabilit√©
```

---

## üß™ **TESTS VALID√âS & SC√âNARIOS**

### **‚úÖ Smart Naming complet**
1. **Nouvelle fiche** ‚Üí "Nouvelle fiche" affich√© ‚úì
2. **Type "Studio" + ville "Lyon"** ‚Üí "Studio Lyon" g√©n√©r√© ‚úì
3. **Modification manuelle** ‚Üí "Mon Appart Personnel" prot√©g√© ‚úì
4. **Modification logement apr√®s manual** ‚Üí Nom reste prot√©g√© ‚úì
5. **Reset nom √† "Nouvelle fiche"** ‚Üí Auto-g√©n√©ration reprend ‚úì
6. **Capitalisation** ‚Üí "Appartement Paris" pas "appartement paris" ‚úì

### **‚úÖ Workflow complet Dashboard ‚Üî Formulaire**
1. **Dashboard ‚Üí Nouvelle fiche** ‚Üí Formulaire vide ‚úì
2. **Remplissage + sauvegarde** ‚Üí Retour Dashboard ‚Üí Fiche list√©e ‚úì
3. **Dashboard ‚Üí Modifier fiche** ‚Üí Donn√©es pr√©-remplies ‚úì
4. **Modification + sauvegarde** ‚Üí Timestamp updated_at mis √† jour ‚úì
5. **Navigation sections** ‚Üí Donn√©es persistantes entre pages ‚úì

### **‚úÖ Suppression & gestion erreurs**
1. **Clic poubelle** ‚Üí Modal confirmation ‚úì
2. **Confirmer** ‚Üí Fiche dispara√Æt imm√©diatement + BDD ‚úì
3. **Annuler** ‚Üí Modal ferme, rien ne change ‚úì
4. **Filtres Dashboard** ‚Üí Compteurs mis √† jour automatiquement ‚úì

### **‚úÖ Affichage conditionnel (FicheClefs)**
1. **Interphone = Non** ‚Üí Champs d√©tails cach√©s ‚úì
2. **Interphone = Oui** ‚Üí Champs d√©tails visibles ‚úì
3. **Type bo√Æte TTlock** ‚Üí Champs TTlock visibles uniquement ‚úì
4. **Sauvegarde bool√©ens** ‚Üí Values true/false/null correctes en base ‚úì

---

## üöÄ **ENVIRONNEMENTS & D√âPLOIEMENT**

### **Production**
- **URL :** https://fiche-logement-ia-githubcopilot-v1.vercel.app/
- **Auto-deploy :** Push `main` ‚Üí Vercel
- **Database :** Supabase Production (RLS activ√©)
- **Performance :** Mobile 3G < 2s loading

### **D√©veloppement**  
- **Local :** `npm run dev` (Vite hot reload)
- **Database :** M√™me instance Supabase (isolation par user_id)
- **Debug :** Console logs + debug panels disponibles

---

## üìä **M√âTRIQUES DE SUCC√àS ACTUELLES**

### **‚úÖ Performance valid√©e**
- ‚è±Ô∏è **Chargement Dashboard** < 1s
- üíæ **Sauvegarde fiche** < 500ms  
- üì± **Score mobile Lighthouse** > 85
- üîÑ **Navigation sections** instantan√©e

### **‚úÖ UX valid√©e**
- üß≠ **Navigation intuitive** (sidebar + boutons synchronis√©s)
- üí° **Smart naming appr√©ci√©** (plus de "Nouvelle fiche" partout)
- üóëÔ∏è **Suppression s√©curis√©e** (z√©ro suppression accidentelle en test)
- üìä **Dashboard lisible** (statuts, dates, recherche efficace)

---

## ‚ö†Ô∏è **LIMITATIONS CONNUES**

### **Techniques**
- **Pas d'offline** : Connexion internet requise
- **RLS strict** : Pas de partage fiches entre users (volontaire)
- **Sauvegarde manuelle** : Pas d'auto-save (choix UX)

### **Fonctionnelles**
- **17 sections manquantes** : Pattern √©tabli pour ajout
- **Pas d'upload photos** : Google Drive API √† int√©grer
- **Pas de PDF g√©n√©ration** : Make.com + GPT √† connecter
- **Statuts workflow incomplet** : "Archiv√©" pas op√©rationnel

---

*Derni√®re mise √† jour : Session du 17 Juin 2025*  
*Architecture valid√©e, pr√™te pour extension 17 sections restantes*

---

## ‚ö†Ô∏è **CONTRAINTES & LIMITATIONS**

### **Business CRITIQUES**
- **üî• COMPATIBILIT√â MONDAY** - Liens existants doivent fonctionner sans modification
  - Query parameters format : `?adresse=123+Rue&ville=Paris&proprietaire=Dupont`
  - Pr√©-remplissage automatique obligatoire (workflow actuel coordinateurs)
  - Pas de rupture dans l'exp√©rience utilisateur

### **Techniques**
- **Supabase RLS** - Isolation users obligatoire
- **Mobile-first** - Design optimis√© petit √©cran prioritaire
- **Offline** - Pas de support hors ligne (connexion requise)

### **Business**
- **Utilisateurs :** < 10 coordinateurs (pas de scale massive)
- **Budget :** Co√ªts Supabase minimaux (free tier suffisant)
- **Maintenance :** Solution simple et maintenable

### **UX**
- **Formation :** Transition douce depuis Jotform
- **Compatibilit√© :** Tous navigateurs mobiles r√©cents
- **Accessibilit√© :** Contraste et tailles tactiles respect√©s

---

## üéâ **SUCC√àS ACTUELS**

‚úÖ **Dashboard fonctionnel** - Navigation + CRUD complet  
‚úÖ **Smart naming** - Auto-g√©n√©ration + contr√¥le utilisateur  
‚úÖ **Persistance robuste** - Sauvegarde + chargement fiables  
‚úÖ **UX mobile** - Interface fluide sur terrain  
‚úÖ **Architecture scalable** - Pr√™t pour 17 sections restantes  

**Status :** üü¢ **Pr√™t pour production MVP** avec 5 sections  
**Next :** üéØ Menu contextuel + nouvelles sections  

---

*Derni√®re mise √† jour : Session du 17 Juin 2025*  
*Contributeurs : Julien (PO), Claude (Dev), Gemini (Dev)*